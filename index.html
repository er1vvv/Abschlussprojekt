<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflexions-Radar v4.2 Fixed</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255,255,255,0.1);
            --glass-border: rgba(255,255,255,0.2);
            --stress-1: #4CAF50;
            --stress-2: #8BC34A;
            --stress-3: #FFC107;
            --stress-4: #FF9800;
            --stress-5: #F44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--primary-gradient);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            min-height: 100vh;
            user-select: none;
        }
        
        /* HEADER */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            border-bottom: 2px solid var(--glass-border);
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            color: white;
            font-size: 20px;
            margin-right: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: 700;
        }
        
        .header-buttons {
            display: flex;
            gap: 8px;
            flex: 1;
            flex-wrap: wrap;
        }
        
        .header-stats {
            display: flex;
            gap: 15px;
            margin-left: auto;
            align-items: center;
        }
        
        .btn {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 44px;
            min-height: 44px;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .btn.active {
            background: rgba(76,175,80,0.3);
            border-color: #4CAF50;
        }
        
        .stat {
            color: white;
            font-size: 12px;
            background: rgba(0,0,0,0.4);
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            font-weight: 600;
        }
        
        /* CANVAS */
        #canvas {
            position: absolute;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0%, transparent 70%);
        }
        
        /* MEMBERS */
        .member {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            font-size: 12px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            user-select: none;
            touch-action: none;
            border: 3px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        
        .member:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.6);
        }
        
        .member.dragging {
            transform: scale(1.15);
            z-index: 50;
        }
        
        .member.self {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.6), 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .member-name {
            font-weight: 700;
            margin-bottom: 4px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-size: 11px;
        }
        
        .stress-indicator {
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255,255,255,0.4);
            font-weight: 600;
        }
        
        .stress-indicator:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.1);
        }
        
        /* CONNECTIONS - FIXED SVG RENDERING */
        .connection-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        
        .connection-svg line {
            stroke-width: 4;
            stroke-linecap: round;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        
        .connection-emoji {
            position: absolute;
            font-size: 24px;
            background: linear-gradient(145deg, rgba(0,0,0,0.95), rgba(0,0,0,0.85));
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(255,255,255,0.6);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            backdrop-filter: blur(15px);
        }
        
        .connection-emoji:hover {
            transform: translate(-50%, -50%) scale(1.3);
            border-color: rgba(255,255,255,0.9);
            box-shadow: 0 6px 25px rgba(0,0,0,0.7);
        }
        
        /* STRESS THERMOMETER - SIMPLIFIED */
        .stress-thermometer {
            position: fixed;
            top: 90px;
            right: 20px;
            width: 100px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--glass-border);
            color: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            z-index: 100;
        }
        
        .thermometer-header {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 14px;
        }
        
        .stress-display {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .stress-value {
            font-size: 32px;
            font-weight: 700;
            color: #FFC107;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .stress-bar {
            height: 120px;
            width: 20px;
            background: linear-gradient(to top, 
                var(--stress-1) 0%, 
                var(--stress-1) 20%, 
                var(--stress-2) 20%, 
                var(--stress-2) 40%, 
                var(--stress-3) 40%, 
                var(--stress-3) 60%, 
                var(--stress-4) 60%, 
                var(--stress-4) 80%, 
                var(--stress-5) 80%, 
                var(--stress-5) 100%);
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            margin: 0 auto;
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .stress-indicator-marker {
            position: absolute;
            right: -8px;
            width: 0;
            height: 0;
            border-left: 8px solid white;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            transition: all 0.3s ease;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }
        
        /* SCALING QUESTIONS UI */
        .scaling-bar {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 5px;
        }
        
        .scaling-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 14px;
            border-radius: 8px;
        }
        
        .scaling-btn.active {
            background: rgba(76,175,80,0.5);
            border-color: #4CAF50;
            transform: scale(1.1);
        }
        
        .scaling-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* REFLEXIONS PANEL */
        .reflexions-panel {
            position: fixed;
            top: 90px;
            right: 140px;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
            width: 320px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--glass-border);
            color: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            z-index: 100;
        }
        
        /* TIMELINE */
        .timeline-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 120px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            z-index: 100;
            border: 2px solid var(--glass-border);
            display: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: white;
            font-weight: 700;
        }
        
        .timeline-controls {
            display: flex;
            gap: 5px;
        }
        
        .timeline-points {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }
        
        .timeline-points::-webkit-scrollbar {
            height: 6px;
        }
        
        .timeline-points::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        .timeline-point {
            min-width: 80px;
            height: 60px;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            text-align: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .timeline-point:hover {
            transform: translateY(-2px) scale(1.05);
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }
        
        .timeline-point.active {
            background: rgba(76,175,80,0.3);
            border-color: #4CAF50;
            transform: scale(1.1);
        }
        
        /* MODALS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(25px);
            border: 2px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }
        
        .modal h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 22px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* CONTEXT MENUS */
        .context-menu {
            position: fixed;
            background: rgba(20,20,20,0.95);
            backdrop-filter: blur(25px);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 180px;
            border: 2px solid var(--glass-border);
            z-index: 1500;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .context-item {
            padding: 12px 16px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .context-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 20px;
        }
        
        /* EMOJI SELECTOR - VISUAL GRID */
        .emoji-selector {
            position: fixed;
            background: rgba(15,15,15,0.95);
            backdrop-filter: blur(25px);
            border-radius: 20px;
            padding: 25px;
            z-index: 1500;
            display: none;
            border: 2px solid var(--glass-border);
            max-width: 400px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.7);
        }
        
        .emoji-selector h3 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .emoji-option {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .emoji-option:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.15);
            border-color: rgba(255,255,255,0.5);
        }
        
        /* REFLEXION ITEMS */
        .reflexion-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 4px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .reflexion-category {
            font-size: 12px;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .reflexion-question {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .reflexion-answer {
            font-size: 13px;
            font-style: italic;
            opacity: 0.9;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .reflexion-assignment {
            font-size: 12px;
            background: rgba(33,150,243,0.1);
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #2196F3;
        }
        
        /* INPUT STYLES */
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 15px rgba(76,175,80,0.3);
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        select option {
            background: #333;
            color: white;
        }
        
        /* NOTIFICATION */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(76,175,80,0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            z-index: 3000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-weight: 600;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header {
                padding: 0 10px;
                height: auto;
                min-height: 70px;
                flex-wrap: wrap;
            }
            
            .header h1 {
                font-size: 16px;
                width: 100%;
                margin-bottom: 8px;
                text-align: center;
            }
            
            .header-buttons {
                justify-content: center;
                width: 100%;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 11px;
                margin: 2px;
            }
            
            #canvas {
                top: 100px;
            }
            
            .member {
                width: 90px;
                height: 90px;
                font-size: 11px;
            }
            
            .stress-thermometer {
                position: fixed;
                bottom: 20px;
                right: 10px;
                width: 80px;
                padding: 15px;
            }
            
            .reflexions-panel {
                right: 10px;
                left: 10px;
                width: auto;
                max-height: 50vh;
            }
            
            .timeline-panel {
                left: 10px;
                right: 10px;
                height: 100px;
            }
            
            .modal {
                padding: 20px 15px;
                width: 95%;
            }
            
            .emoji-selector {
                width: 95%;
                max-width: 350px;
            }
            
            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
            }
            
            .emoji-option {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .scaling-bar {
                gap: 3px;
            }
            
            .scaling-btn {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }
        }
        
        /* UTILITY CLASSES */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-10 { margin-bottom: 10px; }
        .mt-10 { margin-top: 10px; }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1>🎯 Reflexions-Radar v4.2 Fixed</h1>
        
        <div class="header-buttons">
            <button class="btn" id="btnShowReflexion">💭 Reflexion</button>
            <button class="btn" id="btnCaptureSnapshot">📷 Snapshot</button>
            <button class="btn" id="btnToggleTimeline">📊 Timeline</button>
            <button class="btn" id="btnShowExport">📋 Export</button>
            <button class="btn" id="btnShowSessions">📁 Sessions</button>
            <button class="btn" id="btnToggleReflexions">📝 Historie</button>
            <button class="btn" id="btnReset">🔄 Reset</button>
        </div>
        
        <div class="header-stats">
            <div class="stat">👥 <span id="memberCount">3</span></div>
            <div class="stat">🔗 <span id="connectionCount">2</span></div>
            <div class="stat">💭 <span id="reflexionCount">0</span></div>
            <div class="stat">⚡ <span id="avgStress">3.0</span></div>
        </div>
    </div>
    
    <!-- CANVAS -->
    <div id="canvas"></div>
    
    <!-- SIMPLIFIED STRESS THERMOMETER -->
    <div class="stress-thermometer">
        <div class="thermometer-header">
            🌡️ Team-Stress
        </div>
        <div class="stress-display">
            <div class="stress-value" id="avgStressDisplay">3.0</div>
            <div style="font-size: 10px; opacity: 0.7;">von 5.0</div>
        </div>
        <div class="stress-bar">
            <div class="stress-indicator-marker" id="stressMarker"></div>
        </div>
        <div style="font-size: 10px; margin-top: 10px; text-align: center; opacity: 0.7;">
            Klicke Personen<br>für Details
        </div>
    </div>
    
    <!-- REFLEXIONS PANEL -->
    <div class="reflexions-panel" id="reflexionsPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4>💭 Reflexions-Historie</h4>
            <button class="btn" style="padding: 4px 8px; font-size: 12px;" id="btnCloseReflexions">✕</button>
        </div>
        <div id="reflexionsList">
            <p style="text-align: center; opacity: 0.7;">Noch keine Reflexionen</p>
        </div>
    </div>
    
    <!-- TIMELINE PANEL -->
    <div class="timeline-panel" id="timelinePanel">
        <div class="timeline-header">
            <span>📊 Timeline & Entwicklung</span>
            <div class="timeline-controls">
                <button class="btn" id="btnPlayTimeline" style="padding: 6px 10px; font-size: 12px;">▶️ Play</button>
                <button class="btn" id="btnPrevSnapshot" style="padding: 6px 10px; font-size: 12px;">⏮️</button>
                <button class="btn" id="btnNextSnapshot" style="padding: 6px 10px; font-size: 12px;">⏭️</button>
                <button class="btn" id="btnCloseTimeline" style="padding: 6px 10px; font-size: 12px;">✕</button>
            </div>
        </div>
        <div id="timelinePoints" class="timeline-points"></div>
    </div>
    
    <!-- CONTEXT MENUS -->
    <div class="context-menu" id="canvasContextMenu">
        <div class="context-item" data-action="addMember">➕ Person hinzufügen</div>
        <div class="context-item" data-action="captureSnapshot">📷 Snapshot</div>
        <div class="context-item" data-action="showReflexion">💭 Reflexion</div>
    </div>
    
    <div class="context-menu" id="memberContextMenu">
        <div class="context-item" data-action="renameMember">✏️ Umbenennen</div>
        <div class="context-item" data-action="markAsSelf">⭐ Als mich markieren</div>
        <div class="context-item" data-action="changeStress">⚡ Stress ändern</div>
        <div class="context-item" data-action="editNotes">📝 Notizen</div>
        <div class="context-item" data-action="addConnection">🔗 Verbindung erstellen</div>
        <div class="context-item" data-action="deleteMember">🗑️ Löschen</div>
    </div>
    
    <div class="context-menu" id="connectionContextMenu">
        <div class="context-item" data-action="changeEmoji">😀 Emoji ändern</div>
        <div class="context-item" data-action="changeColor">🎨 Farbe ändern</div>
        <div class="context-item" data-action="deleteConnection">🗑️ Löschen</div>
    </div>
    
    <!-- VISUAL EMOJI SELECTOR -->
    <div class="emoji-selector" id="emojiSelector">
        <h3>😀 Emoji wählen</h3>
        <div class="emoji-grid">
            <!-- Cooperation -->
            <div class="emoji-option" data-emoji="🤝" title="Zusammenarbeit">🤝</div>
            <div class="emoji-option" data-emoji="💬" title="Kommunikation">💬</div>
            <div class="emoji-option" data-emoji="❤️" title="Vertrauen">❤️</div>
            <div class="emoji-option" data-emoji="⚡" title="Energie">⚡</div>
            <div class="emoji-option" data-emoji="💔" title="Konflikt">💔</div>
            <div class="emoji-option" data-emoji="🔥" title="Leidenschaft">🔥</div>
            
            <!-- Communication -->
            <div class="emoji-option" data-emoji="👍" title="Zustimmung">👍</div>
            <div class="emoji-option" data-emoji="👎" title="Ablehnung">👎</div>
            <div class="emoji-option" data-emoji="🤔" title="Nachdenken">🤔</div>
            <div class="emoji-option" data-emoji="❓" title="Unklarheit">❓</div>
            <div class="emoji-option" data-emoji="💡" title="Idee">💡</div>
            <div class="emoji-option" data-emoji="🎯" title="Fokus">🎯</div>
            
            <!-- Emotions -->
            <div class="emoji-option" data-emoji="💚" title="Harmonie">💚</div>
            <div class="emoji-option" data-emoji="💙" title="Vertrauen">💙</div>
            <div class="emoji-option" data-emoji="🧡" title="Wärme">🧡</div>
            <div class="emoji-option" data-emoji="💜" title="Respekt">💜</div>
            <div class="emoji-option" data-emoji="🌟" title="Inspiration">🌟</div>
            <div class="emoji-option" data-emoji="⭐" title="Qualität">⭐</div>
            
            <!-- Development -->
            <div class="emoji-option" data-emoji="🚀" title="Fortschritt">🚀</div>
            <div class="emoji-option" data-emoji="🎨" title="Kreativität">🎨</div>
            <div class="emoji-option" data-emoji="🔧" title="Problemlösung">🔧</div>
            <div class="emoji-option" data-emoji="⚙️" title="Prozess">⚙️</div>
            <div class="emoji-option" data-emoji="🔍" title="Analyse">🔍</div>
            <div class="emoji-option" data-emoji="📈" title="Wachstum">📈</div>
            
            <!-- Support -->
            <div class="emoji-option" data-emoji="💪" title="Stärke">💪</div>
            <div class="emoji-option" data-emoji="🛡️" title="Schutz">🛡️</div>
            <div class="emoji-option" data-emoji="🤗" title="Unterstützung">🤗</div>
            <div class="emoji-option" data-emoji="🙏" title="Dankbarkeit">🙏</div>
            <div class="emoji-option" data-emoji="👏" title="Anerkennung">👏</div>
            <div class="emoji-option" data-emoji="🎉" title="Erfolg">🎉</div>
        </div>
        <div class="modal-buttons">
            <button class="btn" id="btnCloseEmojiSelector">✕ Schließen</button>
        </div>
    </div>
    
    <!-- MODALS -->
    <div class="modal-overlay" id="reflexionModal">
        <div class="modal">
            <h3 id="reflexionTitle">💭 Systemische Reflexion</h3>
            <div id="reflexionQuestion" class="mb-10"></div>
            <textarea id="reflexionAnswer" rows="4" placeholder="Deine Gedanken und Erkenntnisse..."></textarea>
            <div id="reflexionAssignment" class="mt-10"></div>
            <div class="modal-buttons">
                <button class="btn" id="btnSaveReflexion">💾 Speichern</button>
                <button class="btn" id="btnNextReflexion">➡️ Nächste</button>
                <button class="btn" id="btnCloseReflexionModal">✕ Schließen</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="snapshotModal">
        <div class="modal">
            <h3>📷 Snapshot erstellen</h3>
            <input type="text" id="snapshotName" placeholder="Snapshot-Name...">
            <div class="modal-buttons">
                <button class="btn" id="btnSaveSnapshot">💾 Speichern</button>
                <button class="btn" id="btnCancelSnapshot">✕ Abbrechen</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3>📋 Export & Arbeitsblatt</h3>
            <div class="mb-10">
                <button class="btn" id="btnExportWorksheet" style="width: 100%; margin-bottom: 10px;">📄 HTML-Arbeitsblatt</button>
                <button class="btn" id="btnExportJSON" style="width: 100%; margin-bottom: 10px;">💾 Session-Daten (JSON)</button>
            </div>
            <div class="modal-buttons">
                <button class="btn" id="btnCloseExport">✕ Schließen</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="sessionModal">
        <div class="modal">
            <h3>📁 Session-Verwaltung</h3>
            
            <div class="mb-10">
                <input type="text" id="sessionName" placeholder="Session-Name...">
                <button class="btn" id="btnSaveSession" style="width: 100%; margin-top: 5px;">💾 Session speichern</button>
            </div>
            
            <div class="mb-10">
                <input type="file" id="sessionFile" accept=".json" style="margin-bottom: 10px;">
                <button class="btn" id="btnImportSession" style="width: 100%;">📥 Importieren</button>
            </div>
            
            <div id="sessionsList" style="max-height: 200px; overflow-y: auto;"></div>
            
            <div class="modal-buttons">
                <button class="btn" id="btnClearSessions">🗑️ Alle löschen</button>
                <button class="btn" id="btnCloseSession">✕ Schließen</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Connection Target Modal -->
    <div class="modal-overlay" id="connectionModal">
        <div class="modal">
            <h3>🔗 Verbindung erstellen</h3>
            <p>Verbindung von <strong id="connectionFromName"></strong> zu:</p>
            <select id="connectionTarget">
                <option value="">-- Person auswählen --</option>
            </select>
            <div class="modal-buttons">
                <button class="btn" id="btnCreateConnection">🔗 Erstellen</button>
                <button class="btn" id="btnCancelConnection">✕ Abbrechen</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION & GLOBALS
        // ==========================================
        
        const APP_VERSION = "4.2-FIXED";
        const AUTO_SAVE_INTERVAL = 30000;
        const MAX_SESSIONS = 10;
        
        // Global State - FIXED STANDARD NAMES
        let members = [
            { id: 1, name: "Person 1", x: 300, y: 200, stress: 4, notes: "", isSelf: false },
            { id: 2, name: "Person 2", x: 200, y: 300, stress: 2, notes: "", isSelf: false },
            { id: 3, name: "Person 3", x: 400, y: 300, stress: 3, notes: "", isSelf: false }
        ];
        
        let connections = [
            { from: 1, to: 2, emoji: "🤝", color: "#4CAF50" },
            { from: 1, to: 3, emoji: "💬", color: "#2196F3" }
        ];
        
        let snapshots = [
            {
                id: 1,
                name: "Ausgangssituation",
                timestamp: new Date().toLocaleString(),
                members: JSON.parse(JSON.stringify(members)),
                connections: JSON.parse(JSON.stringify(connections))
            }
        ];
        
        let reflexionAnswers = [];
        let sessions = [];
        
        // State Management
        let nextId = 4;
        let currentSnapshotIndex = 0;
        let selectedMember = null;
        let selectedConnection = null;
        let draggedMember = null;
        let dragOffset = { x: 0, y: 0 };
        let canvasClickPos = { x: 0, y: 0 };
        let isPlaying = false;
        let playInterval = null;
        let currentReflexionCategory = null;
        let currentReflexionIndex = 0;
        let currentQuestionType = null;
        
        // ==========================================
        // NEW: EXTENDED QUESTION SYSTEMS
        // ==========================================
        
        const REFLEXIONS_SYSTEM = {
            selbstreflexion: {
                name: "🪞 Selbstreflexion",
                color: "#E91E63",
                questions: [
                    "Welche Rolle nehme ich im Team ein?",
                    "Was hindert mich daran, meine Position zu verändern?",
                    "Wo spüre ich Widerstand in mir?",
                    "In welchen Situationen fühle ich mich am authentischsten?",
                    "Was ist mein größter Beitrag zum Team?",
                    "Welche meiner Stärken sind hier noch unsichtbar?",
                    "Was würde ich gerne mehr zeigen?"
                ],
                assignments: [
                    "Achte in den nächsten 7 Tagen darauf, wann du diese Rolle verlässt.",
                    "Beobachte deine körperlichen Reaktionen in Teamsituationen.",
                    "Notiere dir täglich einen Moment der Authentizität.",
                    "Dokumentiere Situationen, in denen du dich zurückhältst."
                ]
            },
            
            beziehungsdynamik: {
                name: "🔗 Beziehungsdynamik",
                color: "#2196F3",
                questions: [
                    "Zu wem habe ich die schwächste Verbindung?",
                    "Welche Beziehung kostet mich Energie?",
                    "Wo entstehen wiederkehrende Muster?",
                    "Wer ist mein wichtigster Verbündeter?",
                    "Mit wem kommuniziere ich am klarsten?",
                    "Wo entstehen Missverständnisse?",
                    "Welche Beziehung hat sich am meisten verändert?"
                ],
                assignments: [
                    "Dokumentiere Momente, in denen sich diese Dynamik zeigt.",
                    "Führe bewusst ein Gespräch mit der schwächsten Verbindung.",
                    "Beobachte nonverbale Signale in Interaktionen.",
                    "Notiere dir Situationen erfolgreicher Zusammenarbeit."
                ]
            },
            
            entwicklung: {
                name: "📈 Entwicklung & Veränderung",
                color: "#4CAF50",
                questions: [
                    "Was hat sich in den letzten Monaten verändert?",
                    "Welche Entwicklung überrascht mich?",
                    "Wo sehe ich Potentiale für Wachstum?",
                    "Was möchte ich lernen?",
                    "Welcher Schritt wäre der nächste?",
                    "Was hindert uns an Veränderung?",
                    "Wo waren wir schon einmal anders?"
                ],
                assignments: [
                    "Dokumentiere eine kleine tägliche Veränderung eine Woche lang.",
                    "Führe ein Entwicklungsgespräch mit einem Teammitglied.",
                    "Beobachte Wachstumsmomente im Team.",
                    "Experimentiere mit einem neuen Verhalten."
                ]
            },
            
            systemisch: {
                name: "🔄 Systemische Perspektiven",
                color: "#FF9800",
                questions: [
                    "Was würde X über Y sagen?",
                    "Welches Problem löst meine Position?",
                    "Was würde fehlen, wenn ich nicht da wäre?",
                    "Wer profitiert von der aktuellen Konstellation?",
                    "Was ist das Symptom, was ist die Ursache?",
                    "Wo sind die Loyalitätskonflikte?",
                    "Was ist der Auftrag des Systems?"
                ],
                assignments: [
                    "Führe ein zirkuläres Interview mit einem Unbeteiligten.",
                    "Beobachte, wer auf Veränderungen wie reagiert.",
                    "Frage drei verschiedene Perspektiven zu derselben Situation ab.",
                    "Achte auf verborgene Regeln und Loyalitäten."
                ]
            },
            
            vision: {
                name: "✨ Visionen & Wünsche",
                color: "#9C27B0",
                questions: [
                    "Wie sähe unser ideales Team aus?",
                    "Was ist mein größter Wunsch für uns?",
                    "Woran würden wir merken, dass es besser ist?",
                    "Was wäre das Kleinste, was sich ändern müsste?",
                    "Wenn ein Wunder geschähe - was wäre anders?",
                    "Welche Atmosphäre wünsche ich mir?",
                    "Was sollen andere über uns sagen?"
                ],
                assignments: [
                    "Visualisiere täglich 5 Minuten das ideale Team.",
                    "Teile deine Vision mit einem Teammitglied.",
                    "Achte auf kleine Wunder im Alltag.",
                    "Setze einen winzig kleinen Schritt zu deiner Vision um."
                ]
            }
        };
        
        // NEW: SCALING QUESTIONS
        const SCALING_QUESTIONS = [
            "Auf einer Skala von 1-10: Wie zufrieden bist du mit deiner Position im Team?",
            "Wie stark fühlst du dich vom Team unterstützt? (1-10)",
            "Wie klar sind dir deine Aufgaben im Team? (1-10)",
            "Wie gut kannst du deine Stärken einbringen? (1-10)",
            "Wie wohl fühlst du dich in der Teamdynamik? (1-10)",
            "Wie effektiv ist unsere Kommunikation? (1-10)",
            "Wie motiviert bist du in diesem Team? (1-10)",
            "Wie gut funktioniert unsere Zusammenarbeit? (1-10)",
            "Wie authentisch kann ich mich im Team zeigen? (1-10)",
            "Wie sehr vertraue ich meinen Teammitgliedern? (1-10)"
        ];
        
        // NEW: MIRACLE QUESTIONS
        const MIRACLE_QUESTIONS = [
            "Angenommen, über Nacht geschähe ein Wunder und unser Team wäre perfekt - woran würden wir das morgen früh merken?",
            "Wenn alle Hindernisse verschwänden - wie würden wir dann zusammenarbeiten?",
            "Stellen Sie sich vor, unser Team wird in einem Jahr als Vorbild genannt - was ist dann anders?",
            "Wenn Sie einen Zauberstab hätten - was würden Sie am Team verändern?",
            "Angenommen, wir hätten unbegrenzte Ressourcen - wie würde unser Team dann aussehen?",
            "Wenn das Team ein Mobile wäre und alle Teile in Balance - wie sähe das aus?",
            "Was wäre das Kleinste, was sich ändern müsste, damit alles perfekt laufe?",
            "Wenn jeder im Team seine Superkraft einsetzen könnte - was würde passieren?",
            "Wenn Kommunikation nie mehr schief gehen würde - wie würde das aussehen?",
            "Wenn alle Konflikte zu Lernmöglichkeiten würden - was wäre anders?"
        ];
        
        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        function getStressColor(level) {
            const colors = {
                1: 'var(--stress-1)',
                2: 'var(--stress-2)',
                3: 'var(--stress-3)',
                4: 'var(--stress-4)',
                5: 'var(--stress-5)'
            };
            return colors[level] || colors[3];
        }
        
        function getStressIcon(level) {
            const icons = { 1: '😌', 2: '🙂', 3: '😐', 4: '😟', 5: '😰' };
            return icons[level] || '😐';
        }
        
        function generateId() {
            return Date.now() + Math.random();
        }
        
        function showNotification(message, duration = 3000) {
            // Remove existing notification
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }
        
        function updateStats() {
            document.getElementById('memberCount').textContent = members.length;
            document.getElementById('connectionCount').textContent = connections.length;
            document.getElementById('reflexionCount').textContent = reflexionAnswers.length;
            
            const avgStress = members.length > 0 ? 
                (members.reduce((sum, m) => sum + m.stress, 0) / members.length) : 0;
            
            document.getElementById('avgStress').textContent = avgStress.toFixed(1);
            document.getElementById('avgStressDisplay').textContent = avgStress.toFixed(1);
            
            // Update stress bar marker position
            const markerPosition = ((avgStress - 1) / 4) * 100; // Convert 1-5 to 0-100%
            const marker = document.getElementById('stressMarker');
            if (marker) {
                marker.style.bottom = `${markerPosition}%`;
            }
        }
        
        // ==========================================
        // DISPLAY & RENDERING - FIXED CONNECTION VISIBILITY
        // ==========================================
        
        function updateDisplay() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            
            // Draw connections first with FIXED rendering
            drawConnections();
            
            // Draw members
            members.forEach(member => {
                const div = document.createElement('div');
                div.className = `member ${member.isSelf ? 'self' : ''} ${draggedMember && draggedMember.id === member.id ? 'dragging' : ''}`;
                div.style.left = member.x + 'px';
                div.style.top = member.y + 'px';
                div.style.background = getStressColor(member.stress);
                div.dataset.memberId = member.id;
                
                div.innerHTML = `
                    <div class="member-name">${member.name}${member.isSelf ? ' ⭐' : ''}</div>
                    <div class="stress-indicator" data-action="cycleStress" data-member-id="${member.id}">
                        ${getStressIcon(member.stress)} ${member.stress}/5
                    </div>
                `;
                
                // Event Listeners
                div.addEventListener('mousedown', (e) => startDrag(e, member));
                div.addEventListener('touchstart', (e) => startDrag(e, member), { passive: false });
                div.addEventListener('contextmenu', (e) => showMemberContextMenu(e, member));
                
                canvas.appendChild(div);
            });
            
            updateStats();
        }
        
        // FIXED: Connection rendering with proper SVG sizing
        function drawConnections() {
            const canvas = document.getElementById('canvas');
            
            if (connections.length === 0) return;
            
            // Create ONE SVG container for ALL lines
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.className = 'connection-svg';
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.zIndex = '2';
            svg.style.pointerEvents = 'none';
            
            connections.forEach(conn => {
                const fromMember = members.find(m => m.id === conn.from);
                const toMember = members.find(m => m.id === conn.to);
                
                if (!fromMember || !toMember) return;
                
                // Create line element
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', fromMember.x + 50);
                line.setAttribute('y1', fromMember.y + 50);
                line.setAttribute('x2', toMember.x + 50);
                line.setAttribute('y2', toMember.y + 50);
                line.setAttribute('stroke', conn.color || '#4CAF50');
                line.setAttribute('stroke-width', '4');
                line.setAttribute('stroke-dasharray', '8,4');
                line.setAttribute('opacity', '0.9');
                line.setAttribute('stroke-linecap', 'round');
                
                svg.appendChild(line);
                
                // Emoji in the middle
                const midX = (fromMember.x + toMember.x) / 2 + 50;
                const midY = (fromMember.y + toMember.y) / 2 + 50;
                
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'connection-emoji';
                emojiDiv.style.left = midX + 'px';
                emojiDiv.style.top = midY + 'px';
                emojiDiv.textContent = conn.emoji;
                emojiDiv.title = `Klicken um zu ändern: ${conn.emoji}`;
                emojiDiv.dataset.connectionFrom = conn.from;
                emojiDiv.dataset.connectionTo = conn.to;
                
                emojiDiv.addEventListener('click', (e) => {
                    selectedConnection = conn;
                    showEmojiSelector(e);
                });
                emojiDiv.addEventListener('contextmenu', (e) => showConnectionContextMenu(e, conn));
                
                canvas.appendChild(emojiDiv);
            });
            
            // Add SVG to canvas FIRST (before emojis)
            canvas.insertBefore(svg, canvas.firstChild);
        }
        
        // ==========================================
        // DRAG & DROP SYSTEM
        // ==========================================
        
        function startDrag(e, member) {
            if (e.target.dataset.action === 'cycleStress') {
                cycleStress(parseInt(e.target.dataset.memberId));
                return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            draggedMember = member;
            selectedMember = member;
            
            const touch = e.touches ? e.touches[0] : e;
            const rect = e.target.getBoundingClientRect();
            
            dragOffset.x = (touch.clientX || e.clientX) - rect.left;
            dragOffset.y = (touch.clientY || e.clientY) - rect.top;
            
            // Add event listeners
            if (e.touches) {
                document.addEventListener('touchmove', handleDrag, { passive: false });
                document.addEventListener('touchend', endDrag);
            } else {
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', endDrag);
            }
            
            updateDisplay();
        }
        
        function handleDrag(e) {
            if (!draggedMember) return;
            e.preventDefault();
            
            const touch = e.touches ? e.touches[0] : e;
            const canvas = document.getElementById('canvas');
            const rect = canvas.getBoundingClientRect();
            
            const clientX = touch.clientX || e.clientX;
            const clientY = touch.clientY || e.clientY;
            
            draggedMember.x = Math.max(0, Math.min(rect.width - 100, clientX - rect.left - dragOffset.x));
            draggedMember.y = Math.max(0, Math.min(rect.height - 100, clientY - rect.top - dragOffset.y));
            
            updateDisplay();
        }
        
        function endDrag() {
            draggedMember = null;
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', handleDrag);
            document.removeEventListener('touchend', endDrag);
            
            updateDisplay();
            autoSave();
        }
        
        // ==========================================
        // MEMBER MANAGEMENT - FIXED STANDARD NAMES
        // ==========================================
        
        function addMemberAtPosition() {
            const newNumber = members.length + 1;
            const newMember = {
                id: nextId++,
                name: `Person ${newNumber}`, // FIXED: Auto-generate standard names
                x: Math.max(50, canvasClickPos.x - 50),
                y: Math.max(50, canvasClickPos.y - 50),
                stress: 3,
                notes: "",
                isSelf: false
            };
            
            members.push(newMember);
            updateDisplay();
            hideAllContextMenus();
            showNotification(`✅ Person ${newNumber} hinzugefügt!`);
            autoSave();
        }
        
        function renameMember() {
            if (!selectedMember) return;
            
            const newName = prompt('Neuer Name:', selectedMember.name);
            if (newName && newName.trim()) {
                selectedMember.name = newName.trim();
                updateDisplay();
                showNotification(`✅ Umbenannt zu "${newName}"`);
                autoSave();
            }
            hideAllContextMenus();
        }
        
        function markAsSelf() {
            if (!selectedMember) return;
            
            // Remove self marker from others
            members.forEach(m => m.isSelf = false);
            
            // Mark current member
            selectedMember.isSelf = true;
            
            updateDisplay();
            hideAllContextMenus();
            showNotification(`⭐ ${selectedMember.name} als "Ich" markiert!`);
            autoSave();
        }
        
        function changeStress() {
            if (!selectedMember) return;
            
            const newStress = prompt(`Stress-Level für ${selectedMember.name} (1-5):`, selectedMember.stress);
            const stress = parseInt(newStress);
            
            if (stress >= 1 && stress <= 5) {
                selectedMember.stress = stress;
                updateDisplay();
                showNotification(`⚡ Stress: ${stress}/5 ${getStressIcon(stress)}`);
                autoSave();
            }
            hideAllContextMenus();
        }
        
        function cycleStress(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            member.stress = member.stress >= 5 ? 1 : member.stress + 1;
            
            selectedMember = member;
            updateDisplay();
            showNotification(`${member.name}: ${getStressIcon(member.stress)} Stress ${member.stress}/5`);
            autoSave();
        }
        
        function editNotes() {
            if (!selectedMember) return;
            
            const notes = prompt(`Notizen für ${selectedMember.name}:`, selectedMember.notes);
            if (notes !== null) {
                selectedMember.notes = notes;
                showNotification('📝 Notizen gespeichert!');
                autoSave();
            }
            hideAllContextMenus();
        }
        
        function deleteMember() {
            if (!selectedMember) return;
            
            if (!confirm(`${selectedMember.name} wirklich löschen?`)) {
                hideAllContextMenus();
                return;
            }
            
            // Remove connections
            connections = connections.filter(c => 
                c.from !== selectedMember.id && c.to !== selectedMember.id
            );
            
            // Remove member
            const memberName = selectedMember.name;
            members = members.filter(m => m.id !== selectedMember.id);
            
            selectedMember = null;
            updateDisplay();
            hideAllContextMenus();
            showNotification(`🗑️ ${memberName} gelöscht!`);
            autoSave();
        }
        
        // ==========================================
        // CONNECTION MANAGEMENT - FIXED DROPDOWN
        // ==========================================
        
        function addConnection() {
            if (!selectedMember) return;
            
            const otherMembers = members.filter(m => m.id !== selectedMember.id);
            if (otherMembers.length === 0) {
                showNotification('⚠️ Keine anderen Personen vorhanden!');
                hideAllContextMenus();
                return;
            }
            
            // Show connection modal with dropdown
            document.getElementById('connectionFromName').textContent = selectedMember.name;
            
            const select = document.getElementById('connectionTarget');
            select.innerHTML = '<option value="">-- Person auswählen --</option>';
            
            otherMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                select.appendChild(option);
            });
            
            hideAllContextMenus();
            showModal('connectionModal');
        }
        
        // NEW: Function for handling connection creation
        function createConnection() {
            const targetId = parseInt(document.getElementById('connectionTarget').value);
            if (!targetId || !selectedMember) {
                showNotification('⚠️ Bitte eine Person auswählen!');
                return;
            }
            
            const target = members.find(m => m.id === targetId);
            if (!target) {
                showNotification('⚠️ Person nicht gefunden!');
                return;
            }
            
            // Check if connection exists
            const exists = connections.some(c => 
                (c.from === selectedMember.id && c.to === target.id) ||
                (c.from === target.id && c.to === selectedMember.id)
            );
            
            if (exists) {
                showNotification('⚠️ Verbindung existiert bereits!');
                hideModal('connectionModal');
                return;
            }
            
            // Create connection
            connections.push({
                from: selectedMember.id,
                to: target.id,
                emoji: '🤝',
                color: '#4CAF50'
            });
            
            updateDisplay();
            hideModal('connectionModal');
            showNotification(`🔗 Verbindung zu ${target.name} erstellt!`);
            autoSave();
        }
        
        // ==========================================
        // VISUAL EMOJI SELECTOR
        // ==========================================
        
        function showEmojiSelector(e) {
            const selector = document.getElementById('emojiSelector');
            selector.style.display = 'block';
            selector.style.left = e.pageX + 10 + 'px';
            selector.style.top = e.pageY + 10 + 'px';
            
            // Adjust position if off screen
            setTimeout(() => {
                const rect = selector.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    selector.style.left = (e.pageX - rect.width - 10) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    selector.style.top = (e.pageY - rect.height - 10) + 'px';
                }
            }, 10);
        }
        
        function selectEmoji(emoji) {
            if (selectedConnection) {
                selectedConnection.emoji = emoji;
                updateDisplay();
                showNotification(`😀 Emoji geändert: ${emoji}`);
                autoSave();
            }
            hideEmojiSelector();
        }
        
        function hideEmojiSelector() {
            document.getElementById('emojiSelector').style.display = 'none';
        }
        
        function changeColor() {
            if (!selectedConnection) return;
            
            const colors = [
                { name: 'Grün (Harmonie)', value: '#4CAF50' },
                { name: 'Blau (Neutral)', value: '#2196F3' },
                { name: 'Orange (Energie)', value: '#FF9800' },
                { name: 'Rot (Konflikt)', value: '#F44336' },
                { name: 'Lila (Kreativ)', value: '#9C27B0' },
                { name: 'Grau (Distanz)', value: '#9E9E9E' }
            ];
            
            const colorList = colors.map((c, i) => `${i + 1}. ${c.name}`).join('\n');
            const selection = prompt(`Farbe wählen:\n\n${colorList}\n\nZahl eingeben:`);
            
            if (!selection) return;
            
            const index = parseInt(selection) - 1;
            if (index >= 0 && index < colors.length) {
                selectedConnection.color = colors[index].value;
                updateDisplay();
                showNotification(`🎨 Farbe: ${colors[index].name}`);
                autoSave();
            }
        }
        
        function deleteConnection() {
            if (!selectedConnection) return;
            
            if (!confirm('Verbindung wirklich löschen?')) return;
            
            const from = members.find(m => m.id === selectedConnection.from);
            const to = members.find(m => m.id === selectedConnection.to);
            
            connections = connections.filter(c => 
                !(c.from === selectedConnection.from && c.to === selectedConnection.to)
            );
            
            selectedConnection = null;
            updateDisplay();
            showNotification(`🗑️ Verbindung ${from?.name} ↔ ${to?.name} gelöscht!`);
            autoSave();
        }
        
        // ==========================================
        // REFLEXIONS SYSTEM - EXTENDED WITH SCALING & MIRACLE
        // ==========================================
        
        function showReflexion() {
            // Random question type selection (FIXED: Extended with scaling and miracle)
            const questionTypes = ['reflexion', 'scaling', 'miracle'];
            const randomType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
            
            let question, title, color, assignment = '', isScaling = false;
            currentQuestionType = randomType;
            
            switch(randomType) {
                case 'scaling':
                    question = SCALING_QUESTIONS[Math.floor(Math.random() * SCALING_QUESTIONS.length)];
                    title = '📊 Skalierungsfrage';
                    color = '#FF9800';
                    isScaling = true;
                    assignment = 'Beobachte in den nächsten Tagen, was deine Bewertung beeinflusst.';
                    break;
                    
                case 'miracle':
                    question = MIRACLE_QUESTIONS[Math.floor(Math.random() * MIRACLE_QUESTIONS.length)];
                    title = '✨ Wunderfrage';
                    color = '#9C27B0';
                    assignment = 'Achte auf kleine Schritte in Richtung deiner Wundervision.';
                    break;
                    
                default: // reflexion
                    const categories = Object.keys(REFLEXIONS_SYSTEM);
                    currentReflexionCategory = categories[Math.floor(Math.random() * categories.length)];
                    const category = REFLEXIONS_SYSTEM[currentReflexionCategory];
                    currentReflexionIndex = Math.floor(Math.random() * category.questions.length);
                    question = category.questions[currentReflexionIndex];
                    title = `💭 ${category.name}`;
                    color = category.color;
                    assignment = category.assignments[Math.floor(Math.random() * category.assignments.length)];
            }
            
            document.getElementById('reflexionTitle').textContent = title;
            document.getElementById('reflexionTitle').style.color = color;
            
            document.getElementById('reflexionQuestion').innerHTML = `
                <div style="font-size: 16px; color: rgba(255,255,255,0.95); margin-bottom: 15px; line-height: 1.5;">
                    ${question}
                </div>
                ${isScaling ? '<div id="scalingBar"></div>' : ''}
            `;
            
            // Generate scaling bar if needed (FIXED: Scaling UI)
            if (isScaling) {
                const scalingBar = document.getElementById('scalingBar');
                scalingBar.innerHTML = `
                    <div class="scaling-bar">
                        ${Array.from({length: 10}, (_, i) => 
                            `<button class="btn scaling-btn" data-scale="${i + 1}">
                                ${i + 1}
                            </button>`
                        ).join('')}
                    </div>
                    <div class="scaling-labels">
                        <span>gar nicht</span>
                        <span>vollkommen</span>
                    </div>
                `;
                
                // Add click handlers for scaling buttons
                document.querySelectorAll('.scaling-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.scaling-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        document.getElementById('reflexionAnswer').value = `Bewertung: ${btn.dataset.scale}/10`;
                        showNotification(`📊 ${btn.dataset.scale}/10 ausgewählt`);
                    });
                });
            }
            
            // Add assignment
            document.getElementById('reflexionAssignment').innerHTML = `
                <div style="background: rgba(33,150,243,0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #2196F3; margin-top: 15px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #2196F3;">📋 Beobachtungsauftrag:</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.9);">${assignment}</div>
                </div>
            `;
            
            document.getElementById('reflexionAnswer').value = '';
            showModal('reflexionModal');
        }
        
        function saveReflexion() {
            const answer = document.getElementById('reflexionAnswer').value.trim();
            
            if (!answer) {
                showNotification('⚠️ Bitte eine Antwort eingeben!');
                return;
            }
            
            let reflexion = {
                id: generateId(),
                timestamp: new Date().toLocaleString()
            };
            
            // Handle different question types
            switch(currentQuestionType) {
                case 'scaling':
                    const questionIndex = SCALING_QUESTIONS.findIndex(q => 
                        document.getElementById('reflexionQuestion').textContent.includes(q.split(':')[0])
                    );
                    reflexion.category = 'scaling';
                    reflexion.categoryName = '📊 Skalierungsfrage';
                    reflexion.question = SCALING_QUESTIONS[questionIndex] || 'Skalierungsfrage';
                    reflexion.answer = answer;
                    reflexion.assignment = 'Beobachte in den nächsten Tagen, was deine Bewertung beeinflusst.';
                    break;
                    
                case 'miracle':
                    const miracleIndex = MIRACLE_QUESTIONS.findIndex(q => 
                        document.getElementById('reflexionQuestion').textContent.includes(q.substring(0, 30))
                    );
                    reflexion.category = 'miracle';
                    reflexion.categoryName = '✨ Wunderfrage';
                    reflexion.question = MIRACLE_QUESTIONS[miracleIndex] || 'Wunderfrage';
                    reflexion.answer = answer;
                    reflexion.assignment = 'Achte auf kleine Schritte in Richtung deiner Wundervision.';
                    break;
                    
                default: // reflexion
                    if (!currentReflexionCategory) return;
                    const category = REFLEXIONS_SYSTEM[currentReflexionCategory];
                    reflexion.category = currentReflexionCategory;
                    reflexion.categoryName = category.name;
                    reflexion.question = category.questions[currentReflexionIndex];
                    reflexion.answer = answer;
                    reflexion.assignment = category.assignments[Math.floor(Math.random() * category.assignments.length)];
            }
            
            reflexionAnswers.push(reflexion);
            
            showNotification('💭 Reflexion gespeichert!');
            updateStats();
            updateReflexionsList();
            autoSave();
        }
        
        function nextReflexion() {
            // Save current if answered
            const answer = document.getElementById('reflexionAnswer').value.trim();
            if (answer) {
                saveReflexion();
            }
            
            // Show new question
            showReflexion();
        }
        
        function toggleReflexionsPanel() {
            const panel = document.getElementById('reflexionsPanel');
            const isVisible = panel.style.display !== 'none';
            
            if (isVisible) {
                panel.style.display = 'none';
            } else {
                updateReflexionsList();
                panel.style.display = 'block';
            }
        }
        
        function updateReflexionsList() {
            const list = document.getElementById('reflexionsList');
            
            if (reflexionAnswers.length === 0) {
                list.innerHTML = '<p style="text-align: center; opacity: 0.7;">Noch keine Reflexionen</p>';
                return;
            }
            
            list.innerHTML = reflexionAnswers.slice(-10).reverse().map(r => {
                const category = REFLEXIONS_SYSTEM[r.category];
                let borderColor = '#4CAF50';
                
                if (r.category === 'scaling') borderColor = '#FF9800';
                else if (r.category === 'miracle') borderColor = '#9C27B0';
                else if (category) borderColor = category.color;
                
                return `
                    <div class="reflexion-item" style="border-left-color: ${borderColor};">
                        <div class="reflexion-category" style="color: ${borderColor};">
                            ${r.categoryName}
                        </div>
                        <div class="reflexion-question">${r.question}</div>
                        <div class="reflexion-answer">"${r.answer}"</div>
                        <div class="reflexion-assignment">
                            <strong>📋 Beobachtungsauftrag:</strong> ${r.assignment}
                        </div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 8px;">
                            ${r.timestamp}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ==========================================
        // TIMELINE SYSTEM
        // ==========================================
        
        function captureSnapshot() {
            if (snapshots.length >= 10) {
                showNotification('⚠️ Maximum 10 Snapshots erreicht!');
                return;
            }
            
            document.getElementById('snapshotName').value = `Snapshot ${snapshots.length + 1}`;
            showModal('snapshotModal');
        }
        
        function saveSnapshot() {
            const name = document.getElementById('snapshotName').value.trim();
            if (!name) {
                showNotification('⚠️ Name erforderlich!');
                return;
            }
            
            const snapshot = {
                id: generateId(),
                name: name,
                timestamp: new Date().toLocaleString(),
                members: JSON.parse(JSON.stringify(members)),
                connections: JSON.parse(JSON.stringify(connections))
            };
            
            snapshots.push(snapshot);
            updateTimelineDisplay();
            
            hideModal('snapshotModal');
            showNotification(`📷 Snapshot "${name}" gespeichert!`);
            autoSave();
        }
        
        function toggleTimeline() {
            const panel = document.getElementById('timelinePanel');
            const isVisible = panel.style.display === 'block';
            
            if (isVisible) {
                panel.style.display = 'none';
                if (isPlaying) stopPlayback();
            } else {
                updateTimelineDisplay();
                panel.style.display = 'block';
            }
        }
        
        function updateTimelineDisplay() {
            const container = document.getElementById('timelinePoints');
            
            if (snapshots.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">Keine Snapshots vorhanden</div>';
                return;
            }
            
            container.innerHTML = snapshots.map((snapshot, index) => `
                <div class="timeline-point ${index === currentSnapshotIndex ? 'active' : ''}" 
                     data-action="loadSnapshot" data-index="${index}">
                    <div style="font-weight: bold; margin-bottom: 4px; font-size: 11px;">${snapshot.name}</div>
                    <div style="font-size: 9px; opacity: 0.7;">${snapshot.timestamp.split(' ')[1]}</div>
                </div>
            `).join('');
        }
        
        function loadSnapshot(index) {
            if (index < 0 || index >= snapshots.length) return;
            
            const snapshot = snapshots[index];
            members = JSON.parse(JSON.stringify(snapshot.members));
            connections = JSON.parse(JSON.stringify(snapshot.connections));
            
            currentSnapshotIndex = index;
            updateDisplay();
            updateTimelineDisplay();
            showNotification(`📷 Snapshot "${snapshot.name}" geladen`);
        }
        
        function playTimeline() {
            if (snapshots.length < 2) {
                showNotification('⚠️ Mindestens 2 Snapshots für Playback nötig!');
                return;
            }
            
            if (isPlaying) {
                stopPlayback();
                return;
            }
            
            isPlaying = true;
            currentSnapshotIndex = 0;
            loadSnapshot(0);
            
            playInterval = setInterval(() => {
                currentSnapshotIndex = (currentSnapshotIndex + 1) % snapshots.length;
                loadSnapshot(currentSnapshotIndex);
            }, 2500);
            
            showNotification('▶️ Timeline-Playback gestartet');
        }
        
        function stopPlayback() {
            isPlaying = false;
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
            showNotification('⏹️ Timeline-Playback gestoppt');
        }
        
        function previousSnapshot() {
            if (currentSnapshotIndex > 0) {
                loadSnapshot(currentSnapshotIndex - 1);
            }
        }
        
        function nextSnapshot() {
            if (currentSnapshotIndex < snapshots.length - 1) {
                loadSnapshot(currentSnapshotIndex + 1);
            }
        }
        
        // ==========================================
        // SESSION MANAGEMENT
        // ==========================================
        
        function showSessions() {
            updateSessionsList();
            showModal('sessionModal');
        }
        
        function saveSession() {
            const name = document.getElementById('sessionName').value.trim();
            if (!name) {
                showNotification('⚠️ Session-Name erforderlich!');
                return;
            }
            
            if (sessions.length >= MAX_SESSIONS) {
                showNotification(`⚠️ Maximum ${MAX_SESSIONS} Sessions erreicht!`);
                return;
            }
            
            const session = {
                id: generateId(),
                name: name,
                timestamp: new Date().toLocaleString(),
                version: APP_VERSION,
                data: {
                    members: JSON.parse(JSON.stringify(members)),
                    connections: JSON.parse(JSON.stringify(connections)),
                    snapshots: JSON.parse(JSON.stringify(snapshots)),
                    reflexionAnswers: JSON.parse(JSON.stringify(reflexionAnswers))
                }
            };
            
            sessions.push(session);
            localStorage.setItem('reflexions-radar-sessions', JSON.stringify(sessions));
            
            updateSessionsList();
            document.getElementById('sessionName').value = '';
            showNotification(`💾 Session "${name}" gespeichert!`);
        }
        
        function loadSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            if (!confirm(`Session "${session.name}" laden? Aktuelle Daten gehen verloren!`)) return;
            
            const data = session.data;
            members = JSON.parse(JSON.stringify(data.members));
            connections = JSON.parse(JSON.stringify(data.connections));
            snapshots = JSON.parse(JSON.stringify(data.snapshots || []));
            reflexionAnswers = JSON.parse(JSON.stringify(data.reflexionAnswers || []));
            
            // Update IDs
            nextId = Math.max(...members.map(m => m.id), 0) + 1;
            currentSnapshotIndex = 0;
            
            updateDisplay();
            hideModal('sessionModal');
            showNotification(`📁 Session "${session.name}" geladen!`);
        }
        
        function deleteSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            if (!confirm(`Session "${session.name}" löschen?`)) return;
            
            sessions = sessions.filter(s => s.id !== sessionId);
            localStorage.setItem('reflexions-radar-sessions', JSON.stringify(sessions));
            
            updateSessionsList();
            showNotification(`🗑️ Session "${session.name}" gelöscht!`);
        }
        
        function clearAllSessions() {
            if (!confirm('ALLE Sessions löschen? Diese Aktion kann nicht rückgängig gemacht werden!')) return;
            
            sessions = [];
            localStorage.removeItem('reflexions-radar-sessions');
            updateSessionsList();
            showNotification('🗑️ Alle Sessions gelöscht!');
        }
        
        function updateSessionsList() {
            const list = document.getElementById('sessionsList');
            
            if (sessions.length === 0) {
                list.innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center;">Keine gespeicherten Sessions</p>';
                return;
            }
            
            list.innerHTML = sessions.map(session => `
                <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 4px;">${session.name}</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7);">${session.timestamp}</div>
                    </div>
                    <div>
                        <button class="btn" data-action="loadSession" data-session-id="${session.id}" 
                                style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">📁</button>
                        <button class="btn" data-action="deleteSession" data-session-id="${session.id}" 
                                style="padding: 4px 8px; font-size: 12px;">🗑️</button>
                    </div>
                </div>
            `).join('');
        }
        
        function importSession() {
            const fileInput = document.getElementById('sessionFile');
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const sessionData = JSON.parse(e.target.result);
                    
                    if (!sessionData.data || !sessionData.data.members) {
                        throw new Error('Ungültiges Datenformat');
                    }
                    
                    if (!confirm(`Session "${sessionData.name}" importieren? Aktuelle Daten gehen verloren!`)) return;
                    
                    const data = sessionData.data;
                    members = data.members || [];
                    connections = data.connections || [];
                    snapshots = data.snapshots || [];
                    reflexionAnswers = data.reflexionAnswers || [];
                    
                    nextId = Math.max(...members.map(m => m.id), 0) + 1;
                    currentSnapshotIndex = 0;
                    
                    updateDisplay();
                    hideModal('sessionModal');
                    showNotification(`📥 Session "${sessionData.name}" importiert!`);
                    
                } catch (error) {
                    showNotification('⚠️ Fehler beim Importieren der Datei!');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
        }
        
        // ==========================================
        // EXPORT SYSTEM
        // ==========================================
        
        function showExport() {
            showModal('exportModal');
        }
        
        function exportWorksheet() {
            const selfMember = members.find(m => m.isSelf);
            const focusMember = selfMember || members.reduce((prev, curr) => 
                prev.stress > curr.stress ? prev : curr
            );
            
            const avgStress = (members.reduce((sum, m) => sum + m.stress, 0) / members.length).toFixed(1);
            const date = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            
            const html = `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systemisches Arbeitsblatt - ${date}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 40px 20px; background: #f8f9fa; }
        .header { text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #667eea; margin-bottom: 10px; font-size: 2.2em; }
        .session-info { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-item { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; text-align: center; }
        .section { background: white; padding: 25px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h3 { color: #667eea; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .member-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .member-card { border: 2px solid #eee; border-radius: 8px; padding: 15px; background: #f8f9fa; }
        .member-card.self { border-color: #FFD700; background: #fff9c4; }
        .stress-indicator { display: inline-block; padding: 4px 8px; border-radius: 20px; color: white; font-weight: bold; font-size: 12px; }
        .stress-1 { background: #4CAF50; } .stress-2 { background: #8BC34A; } .stress-3 { background: #FFC107; color: #333; } .stress-4 { background: #FF9800; } .stress-5 { background: #F44336; }
        .connections { display: flex; flex-wrap: wrap; gap: 10px; }
        .connection { background: #667eea; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; }
        .reflexion-item { background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 15px; }
        .question { font-weight: bold; margin-bottom: 8px; color: #555; }
        .answer { font-style: italic; color: #666; margin-bottom: 10px; }
        .assignment { background: #e3f2fd; padding: 10px; border-radius: 5px; font-size: 14px; border: 1px solid #90caf9; }
        .observation-space { border: 2px dashed #ccc; padding: 20px; margin: 20px 0; min-height: 100px; background: #fafafa; border-radius: 8px; }
        @media print { body { background: white; font-size: 12px; } .session-info { background: #667eea !important; -webkit-print-color-adjust: exact; } .section { box-shadow: none; border: 1px solid #ddd; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎯 Reflexions-Radar</h1>
        <p>Systemisches Arbeitsblatt</p>
    </div>
    
    <div class="session-info">
        <h2>Session vom ${date}</h2>
        <p><strong>Erstellt am:</strong> ${date}, ${time}</p>
        <p><strong>Personalisiert für:</strong> ${focusMember.name}${focusMember.isSelf ? ' ⭐' : ''}</p>
        <p><strong>Stress-Level:</strong> ${focusMember.stress}/5 ${getStressIcon(focusMember.stress)}</p>
        
        <div class="stats-grid">
            <div class="stat-item"><strong>👥 Mitglieder</strong><br>${members.length}</div>
            <div class="stat-item"><strong>🔗 Verbindungen</strong><br>${connections.length}</div>
            <div class="stat-item"><strong>💭 Reflexionen</strong><br>${reflexionAnswers.length}</div>
            <div class="stat-item"><strong>⚡ Ø Stress</strong><br>${avgStress}/5</div>
            <div class="stat-item"><strong>📊 Snapshots</strong><br>${snapshots.length}</div>
        </div>
    </div>
    
    <div class="section">
        <h3>👥 Team-Konstellation</h3>
        <div class="member-grid">
            ${members.map(member => `
                <div class="member-card ${member.isSelf ? 'self' : ''}">
                    <h4>${member.name}${member.isSelf ? ' ⭐' : ''}</h4>
                    <p><span class="stress-indicator stress-${member.stress}">Stress ${member.stress}/5</span></p>
                    ${member.notes ? `<p><strong>Notizen:</strong> ${member.notes}</p>` : ''}
                </div>
            `).join('')}
        </div>
    </div>
    
    <div class="section">
        <h3>🔗 Beziehungs-Netzwerk</h3>
        <div class="connections">
            ${connections.map(conn => {
                const fromMember = members.find(m => m.id === conn.from);
                const toMember = members.find(m => m.id === conn.to);
                return `<div class="connection">${fromMember?.name} ${conn.emoji} ${toMember?.name}</div>`;
            }).join('')}
        </div>
        ${connections.length === 0 ? '<p style="color: #888;">Noch keine Verbindungen erstellt.</p>' : ''}
    </div>
    
    <div class="section">
        <h3>💭 Reflexions-Erkenntnisse</h3>
        ${reflexionAnswers.slice(-5).map(r => `
            <div class="reflexion-item">
                <div class="question">${r.categoryName}: ${r.question}</div>
                <div class="answer">"${r.answer}"</div>
                <div class="assignment"><strong>🔍 Beobachtungsauftrag:</strong> ${r.assignment}</div>
            </div>
        `).join('')}
        ${reflexionAnswers.length === 0 ? '<p style="color: #888;">Noch keine Reflexionen beantwortet.</p>' : ''}
    </div>
    
    <div class="section">
        <h3>🎯 Arbeitsaufträge für ${focusMember.name}</h3>
        
        <h4>🔍 Diese Woche beobachten:</h4>
        <ul>
            <li>In welchen Situationen fühlst du dich im Team am authentischsten?</li>
            <li>Wann veränderst du deine gewohnte Position?</li>
            <li>Welche Reaktionen bemerkst du bei Stress-Level ${focusMember.stress}?</li>
        </ul>
        
        <div class="observation-space">
            <strong>🖊️ Platz für eigene Beobachtungen...</strong><br><br>
            <div style="border-bottom: 1px solid #ddd; margin: 20px 0; padding-bottom: 5px;"></div>
            <div style="border-bottom: 1px solid #ddd; margin: 20px 0; padding-bottom: 5px;"></div>
            <div style="border-bottom: 1px solid #ddd; margin: 20px 0; padding-bottom: 5px;"></div>
            <div style="border-bottom: 1px solid #ddd; margin: 20px 0; padding-bottom: 5px;"></div>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 40px; color: #888; font-size: 14px;">
        <p>Erstellt mit Reflexions-Radar v${APP_VERSION} | ${new Date().toLocaleString()}</p>
    </div>
</body>
</html>`;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(html);
            newWindow.document.close();
            
            hideModal('exportModal');
            showNotification('📄 Arbeitsblatt erstellt!');
            
            setTimeout(() => {
                if (confirm('Als PDF speichern? (Drucken-Dialog öffnet sich)')) {
                    newWindow.print();
                }
            }, 1000);
        }
        
        function exportJSON() {
            const sessionData = {
                name: `Reflexions-Radar Export ${new Date().toLocaleDateString()}`,
                timestamp: new Date().toLocaleString(),
                version: APP_VERSION,
                data: {
                    members: members,
                    connections: connections,
                    snapshots: snapshots,
                    reflexionAnswers: reflexionAnswers
                }
            };
            
            const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `reflexions-radar-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            hideModal('exportModal');
            showNotification('💾 Session exportiert!');
        }
        
        // ==========================================
        // CONTEXT MENUS & UI
        // ==========================================
        
        function showMemberContextMenu(e, member) {
            e.preventDefault();
            e.stopPropagation();
            
            selectedMember = member;
            
            const menu = document.getElementById('memberContextMenu');
            showContextMenuAt(menu, e.pageX || e.clientX, e.pageY || e.clientY);
        }
        
        function showConnectionContextMenu(e, connection) {
            e.preventDefault();
            e.stopPropagation();
            
            selectedConnection = connection;
            
            const menu = document.getElementById('connectionContextMenu');
            showContextMenuAt(menu, e.pageX || e.clientX, e.pageY || e.clientY);
        }
        
        function showCanvasContextMenu(e) {
            e.preventDefault();
            
            canvasClickPos.x = e.offsetX;
            canvasClickPos.y = e.offsetY;
            
            const menu = document.getElementById('canvasContextMenu');
            showContextMenuAt(menu, e.pageX, e.pageY);
        }
        
        function showContextMenuAt(menu, x, y) {
            hideAllContextMenus();
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
            
            // Adjust position if off screen
            setTimeout(() => {
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    menu.style.left = (x - rect.width) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    menu.style.top = (y - rect.height) + 'px';
                }
            }, 10);
        }
        
        function hideAllContextMenus() {
            document.querySelectorAll('.context-menu').forEach(menu => {
                menu.style.display = 'none';
            });
            hideEmojiSelector();
        }
        
        // ==========================================
        // MODAL SYSTEM
        // ==========================================
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        function resetAll() {
            if (!confirm('Alles zurücksetzen? Alle Daten gehen verloren!')) return;
            
            // FIXED: Reset with standard names
            members = [
                { id: 1, name: "Person 1", x: 300, y: 200, stress: 4, notes: "", isSelf: false },
                { id: 2, name: "Person 2", x: 200, y: 300, stress: 2, notes: "", isSelf: false },
                { id: 3, name: "Person 3", x: 400, y: 300, stress: 3, notes: "", isSelf: false }
            ];
            
            connections = [
                { from: 1, to: 2, emoji: "🤝", color: "#4CAF50" },
                { from: 1, to: 3, emoji: "💬", color: "#2196F3" }
            ];
            
            snapshots = [{
                id: 1,
                name: "Ausgangssituation", 
                timestamp: new Date().toLocaleString(),
                members: JSON.parse(JSON.stringify(members)),
                connections: JSON.parse(JSON.stringify(connections))
            }];
            
            reflexionAnswers = [];
            nextId = 4;
            currentSnapshotIndex = 0;
            
            updateDisplay();
            updateTimelineDisplay();
            hideAllContextMenus();
            showNotification('🔄 Alles zurückgesetzt!');
            autoSave();
        }
        
        function autoSave() {
            const saveData = {
                members,
                connections,
                snapshots,
                reflexionAnswers,
                version: APP_VERSION,
                timestamp: new Date().toLocaleString()
            };
            
            localStorage.setItem('reflexions-radar-autosave', JSON.stringify(saveData));
        }
        
        function autoLoad() {
            try {
                const savedData = localStorage.getItem('reflexions-radar-autosave');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    if (data.members && data.connections) {
                        members = data.members;
                        connections = data.connections;
                        snapshots = data.snapshots || snapshots;
                        reflexionAnswers = data.reflexionAnswers || [];
                        
                        nextId = Math.max(...members.map(m => m.id), 0) + 1;
                        
                        updateDisplay();
                        updateTimelineDisplay();
                        showNotification('📁 Daten wiederhergestellt!');
                    }
                }
                
                // Load sessions
                const savedSessions = localStorage.getItem('reflexions-radar-sessions');
                if (savedSessions) {
                    sessions = JSON.parse(savedSessions);
                }
                
            } catch (error) {
                console.error('Auto-load error:', error);
            }
        }
        
        // ==========================================
        // EVENT LISTENERS & INITIALIZATION
        // ==========================================
        
        function initializeEventListeners() {
            // Header buttons
            document.getElementById('btnShowReflexion').addEventListener('click', showReflexion);
            document.getElementById('btnCaptureSnapshot').addEventListener('click', captureSnapshot);
            document.getElementById('btnToggleTimeline').addEventListener('click', toggleTimeline);
            document.getElementById('btnShowExport').addEventListener('click', showExport);
            document.getElementById('btnShowSessions').addEventListener('click', showSessions);
            document.getElementById('btnToggleReflexions').addEventListener('click', toggleReflexionsPanel);
            document.getElementById('btnReset').addEventListener('click', resetAll);
            
            // Timeline controls
            document.getElementById('btnPlayTimeline').addEventListener('click', playTimeline);
            document.getElementById('btnPrevSnapshot').addEventListener('click', previousSnapshot);
            document.getElementById('btnNextSnapshot').addEventListener('click', nextSnapshot);
            document.getElementById('btnCloseTimeline').addEventListener('click', toggleTimeline);
            
            // Reflexions panel
            document.getElementById('btnCloseReflexions').addEventListener('click', toggleReflexionsPanel);
            
            // Modal buttons
            document.getElementById('btnSaveReflexion').addEventListener('click', saveReflexion);
            document.getElementById('btnNextReflexion').addEventListener('click', nextReflexion);
            document.getElementById('btnCloseReflexionModal').addEventListener('click', () => hideModal('reflexionModal'));
            
            document.getElementById('btnSaveSnapshot').addEventListener('click', saveSnapshot);
            document.getElementById('btnCancelSnapshot').addEventListener('click', () => hideModal('snapshotModal'));
            
            document.getElementById('btnExportWorksheet').addEventListener('click', exportWorksheet);
            document.getElementById('btnExportJSON').addEventListener('click', exportJSON);
            document.getElementById('btnCloseExport').addEventListener('click', () => hideModal('exportModal'));
            
            document.getElementById('btnSaveSession').addEventListener('click', saveSession);
            document.getElementById('btnImportSession').addEventListener('click', importSession);
            document.getElementById('btnClearSessions').addEventListener('click', clearAllSessions);
            document.getElementById('btnCloseSession').addEventListener('click', () => hideModal('sessionModal'));
            
            // FIXED: Connection modal buttons
            document.getElementById('btnCreateConnection').addEventListener('click', createConnection);
            document.getElementById('btnCancelConnection').addEventListener('click', () => hideModal('connectionModal'));
            
            // Emoji selector
            document.getElementById('btnCloseEmojiSelector').addEventListener('click', hideEmojiSelector);
            
            // Emoji grid clicks
            document.querySelectorAll('.emoji-option').forEach(option => {
                option.addEventListener('click', () => {
                    const emoji = option.dataset.emoji;
                    selectEmoji(emoji);
                });
            });
            
            // Canvas event listeners
            document.getElementById('canvas').addEventListener('contextmenu', showCanvasContextMenu);
            
            // Global click handler
            document.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                
                if (!action) {
                    if (!e.target.closest('.context-menu') && 
                        !e.target.closest('.member') && 
                        !e.target.closest('.connection-emoji') &&
                        !e.target.closest('.emoji-selector')) {
                        hideAllContextMenus();
                    }
                    return;
                }
                
                // Handle data-action clicks
                switch (action) {
                    case 'addMember':
                        addMemberAtPosition();
                        break;
                    case 'captureSnapshot':
                        captureSnapshot();
                        break;
                    case 'showReflexion':
                        showReflexion();
                        break;
                    case 'renameMember':
                        renameMember();
                        break;
                    case 'markAsSelf':
                        markAsSelf();
                        break;
                    case 'changeStress':
                        changeStress();
                        break;
                    case 'editNotes':
                        editNotes();
                        break;
                    case 'addConnection':
                        addConnection();
                        break;
                    case 'deleteMember':
                        deleteMember();
                        break;
                    case 'changeEmoji':
                        // Handled by connection click event
                        break;
                    case 'changeColor':
                        changeColor();
                        break;
                    case 'deleteConnection':
                        deleteConnection();
                        break;
                    case 'loadSnapshot':
                        loadSnapshot(parseInt(e.target.dataset.index));
                        break;
                    case 'loadSession':
                        loadSession(e.target.dataset.sessionId);
                        break;
                    case 'deleteSession':
                        deleteSession(e.target.dataset.sessionId);
                        break;
                }
            });
            
            // Modal overlay clicks
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.style.display = 'none';
                    }
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            autoSave();
                            showNotification('💾 Gespeichert!');
                            break;
                        case 'r':
                            e.preventDefault();
                            showReflexion();
                            break;
                    }
                }
                
                if (e.key === 'Escape') {
                    hideAllContextMenus();
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });
        }
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🎯 Reflexions-Radar v4.2 Fixed initializing...');
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Auto-load saved data
            autoLoad();
            
            // Initial display
            updateDisplay();
            updateTimelineDisplay();
            
            // Auto-save interval
            setInterval(autoSave, AUTO_SAVE_INTERVAL);
            
            // Welcome message
            setTimeout(() => {
                showNotification('🎯 Reflexions-Radar v4.2 Fixed bereit!');
            }, 1000);
            
            console.log('✅ Reflexions-Radar v4.2 Fixed successfully loaded!');
        });
    </script>
</body>
</html>
