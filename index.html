<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflexions-Radar - Systemische Selbstreflexion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.export-btn {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(69, 160, 73, 0.3));
            border: 1px solid rgba(76, 175, 80, 0.4);
            font-weight: bold;
        }

        .workspace {
            position: relative;
            height: calc(100vh - 100px);
            overflow: hidden;
        }

        .team-member {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-weight: bold;
            text-align: center;
            font-size: 12px;
            user-select: none;
            width: 100px;
            height: 100px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .team-member:hover {
            transform: scale(1.05);
        }

        .stress-1 { background: linear-gradient(135deg, rgba(46, 125, 50, 0.8), rgba(76, 175, 80, 0.8)); }
        .stress-2 { background: linear-gradient(135deg, rgba(104, 159, 56, 0.8), rgba(139, 195, 74, 0.8)); }
        .stress-3 { background: linear-gradient(135deg, rgba(255, 152, 0, 0.8), rgba(255, 183, 77, 0.8)); }
        .stress-4 { background: linear-gradient(135deg, rgba(245, 124, 0, 0.8), rgba(255, 143, 0, 0.8)); }
        .stress-5 { 
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.8), rgba(239, 83, 80, 0.8));
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .connection-line {
            position: absolute;
            height: 3px;
            background: rgba(255, 255, 255, 0.4);
            transform-origin: left center;
            cursor: pointer;
            border-radius: 2px;
        }

        .connection-emoji {
            position: absolute;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .popup h3 {
            color: #81C784;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 18px;
            cursor: pointer;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 200px;
        }

        .legend h4 {
            margin-bottom: 15px;
            color: #81C784;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .legend-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .text-response-area {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 14px;
            min-height: 80px;
            font-family: inherit;
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }

        .ai-response {
            background: rgba(129, 199, 132, 0.2);
            border-left: 4px solid #81C784;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üéØ Reflexions-Radar</div>
        <div class="controls">
            <button class="btn" id="reflectionBtn">üí≠ Reflexion</button>
            <button class="btn" id="scalingBtn">üìä Skalierung</button>
            <button class="btn" id="wonderBtn">‚ú® Wunderfrage</button>
            <button class="btn" id="addPersonBtn">+ Person</button>
            <button class="btn" id="backBtn">‚Ü©Ô∏è Zur√ºck</button>
            <button class="btn" id="forwardBtn">‚Ü™Ô∏è Vorw√§rts</button>
            <button class="btn" id="sessionBtn">üìÑ Session</button>
            <button class="btn export-btn" id="worksheetBtn">üìã Arbeitsblatt</button>
            <button class="btn" id="resetBtn">üîÑ Reset</button>
        </div>
    </div>

    <div class="workspace" id="workspace">
        <div class="legend">
            <h4>Stress-Level</h4>
            <div class="legend-item">
                <div class="legend-circle stress-1"></div>
                <span>1 - Sehr entspannt</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle stress-2"></div>
                <span>2 - Entspannt</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle stress-3"></div>
                <span>3 - Angespannt</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle stress-4"></div>
                <span>4 - Sehr angespannt</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle stress-5"></div>
                <span>5 - √úberlastet</span>
            </div>
            <div style="margin-top: 15px; font-size: 11px; color: #ccc;">
                üí° Doppelklick = Stress √§ndern<br>
                üñ±Ô∏è Halten & Ziehen = Position √§ndern<br>
                üîó Linie klicken = Beziehung bearbeiten
            </div>
        </div>

        <div class="stats">
            <h4 style="color: #81C784; margin-bottom: 10px;">Reflexions-Impulse</h4>
            <div style="font-size: 12px; line-height: 1.4;">
                <div>Durchschnittlicher Stress: <span id="avgStress">Mittel</span></div>
                <div>Belastete Bereiche: <span id="overloaded">1</span></div>
                <div style="margin-top: 10px; color: #ccc;">
                    üí≠ Betrachte deine Position<br>
                    üéØ Erkenne Muster<br>
                    üå± Reflektiere deinen Beitrag
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        var members = [
            { id: 1, name: 'Anna\n(Projektleitung)', x: 200, y: 150, stress: 4 },
            { id: 2, name: 'Marcus\n(Entwicklung)', x: 400, y: 250, stress: 3 },
            { id: 3, name: 'Sarah\n(Design)', x: 300, y: 400, stress: 1 },
            { id: 4, name: 'Tom\n(QA)', x: 600, y: 200, stress: 2 }
        ];
        
        var connections = [];
        var nextId = 5;
        var isDragging = false;
        var dragElement = null;
        var dragOffset = { x: 0, y: 0 };
        var userResponses = [];
        var stateHistory = [];
        var currentStateIndex = -1;

        // Interaction variables
        var clickCount = 0;
        var clickTimer = null;
        var holdTimer = null;
        var isHolding = false;
        var startPos = { x: 0, y: 0 };

        var reflections = [
            "ü™û Welche Rolle √ºbernimmst du normalerweise in stressigen Teamsituationen?",
            "üí≠ Was ist dein automatisches Verhalten, wenn im Team Spannungen entstehen?",
            "üå± Wof√ºr ist deine Position im Team n√ºtzlich - auch wenn sie manchmal anstrengend ist?",
            "üëÅÔ∏è Welche Muster bei dir wiederholen sich in verschiedenen Teams?",
            "üí™ Wann warst du zuletzt √ºberrascht von deiner eigenen Wirkung im Team?"
        ];

        var wonderQuestions = [
            "‚ú® Stell dir vor, morgen wachst du auf und f√ºhlst dich im Team v√∂llig authentisch. Was w√§re das erste Zeichen?",
            "üåü Wenn alle Teamspannungen verschwinden w√ºrden - welche deiner St√§rken w√ºrden sichtbarer?",
            "üí´ Du wachst morgen auf und hast die ideale Teamrolle. Wie w√ºrde dein Arbeitsalltag aussehen?"
        ];

        var scalingQuestions = [
            { text: 'Wie authentisch kannst du aktuell im Team sein?', desc: '1 = Verstelle mich stark, 10 = V√∂llig authentisch' },
            { text: 'Wie wohl f√ºhlst du dich mit deiner aktuellen Teamrolle?', desc: '1 = Sehr unwohl, 10 = V√∂llig wohl' },
            { text: 'Wie stark f√ºhlst du dich emotional mit dem Team verbunden?', desc: '1 = Gar nicht verbunden, 10 = Sehr verbunden' }
        ];

        function init() {
            try {
                initConnections();
                createMembers();
                updateConnections();
                updateStats();
                saveState();
                
                // Event listeners f√ºr Buttons
                document.getElementById('reflectionBtn').addEventListener('click', showReflection);
                document.getElementById('scalingBtn').addEventListener('click', showScaling);
                document.getElementById('wonderBtn').addEventListener('click', showWonder);
                document.getElementById('addPersonBtn').addEventListener('click', addPerson);
                document.getElementById('backBtn').addEventListener('click', goBack);
                document.getElementById('forwardBtn').addEventListener('click', goForward);
                document.getElementById('sessionBtn').addEventListener('click', showSessionSummary);
                document.getElementById('worksheetBtn').addEventListener('click', exportSystemicWorksheet);
                document.getElementById('resetBtn').addEventListener('click', resetAll);
                
                setTimeout(function() {
                    showPopup('Willkommen beim Reflexions-Radar! üéØ', 
                        'Bedienung:<br>' +
                        '‚Ä¢ Doppelklick auf Kreise: Stress-Level √§ndern<br>' +
                        '‚Ä¢ Kreis gedr√ºckt halten: Position verschieben<br>' +
                        '‚Ä¢ Linien anklicken: Beziehungen charakterisieren<br>' +
                        '‚Ä¢ Reflexionsfragen nutzen: F√ºr tiefere Einsichten<br>' +
                        '‚Ä¢ Arbeitsblatt erstellen: Mit Notizfeldern');
                }, 1000);
            } catch (error) {
                console.error('Init error:', error);
            }
        }

        function saveState() {
            var state = {
                members: JSON.parse(JSON.stringify(members)),
                connections: JSON.parse(JSON.stringify(connections)),
                timestamp: Date.now()
            };
            
            stateHistory = stateHistory.slice(0, currentStateIndex + 1);
            stateHistory.push(state);
            currentStateIndex = stateHistory.length - 1;
            
            if (stateHistory.length > 20) {
                stateHistory.shift();
                currentStateIndex--;
            }
            
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            var backBtn = document.getElementById('backBtn');
            var forwardBtn = document.getElementById('forwardBtn');
            
            backBtn.disabled = currentStateIndex <= 0;
            forwardBtn.disabled = currentStateIndex >= stateHistory.length - 1;
        }

        function goBack() {
            if (currentStateIndex > 0) {
                currentStateIndex--;
                var state = stateHistory[currentStateIndex];
                
                members = JSON.parse(JSON.stringify(state.members));
                connections = JSON.parse(JSON.stringify(state.connections));
                
                createMembers();
                updateConnections();
                updateStats();
                updateNavigationButtons();
            }
        }

        function goForward() {
            if (currentStateIndex < stateHistory.length - 1) {
                currentStateIndex++;
                var state = stateHistory[currentStateIndex];
                
                members = JSON.parse(JSON.stringify(state.members));
                connections = JSON.parse(JSON.stringify(state.connections));
                
                createMembers();
                updateConnections();
                updateStats();
                updateNavigationButtons();
            }
        }

        function initConnections() {
            connections = [];
            for (var i = 0; i < members.length; i++) {
                for (var j = i + 1; j < members.length; j++) {
                    connections.push({
                        id: members[i].id + '-' + members[j].id,
                        member1: members[i].id,
                        member2: members[j].id,
                        emoji: 'ü§ù'
                    });
                }
            }
        }

        function createMembers() {
            var workspace = document.getElementById('workspace');
            var existingMembers = workspace.querySelectorAll('.team-member');
            for (var i = 0; i < existingMembers.length; i++) {
                existingMembers[i].remove();
            }
            
            for (var i = 0; i < members.length; i++) {
                var member = members[i];
                var div = document.createElement('div');
                div.className = 'team-member stress-' + member.stress;
                div.style.left = member.x + 'px';
                div.style.top = member.y + 'px';
                div.style.position = 'absolute';
                div.textContent = member.name;
                div.dataset.id = member.id;
                
                div.addEventListener('mousedown', handleInteractionStart);
                div.addEventListener('touchstart', handleInteractionStart);
                
                workspace.appendChild(div);
            }
        }

        function handleInteractionStart(e) {
            e.preventDefault();
            
            var element = e.target.closest('.team-member');
            var clientX = e.clientX || (e.touches && e.touches[0].clientX);
            var clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            startPos = { x: clientX, y: clientY };
            isHolding = false;
            
            clickCount++;
            if (clickCount === 1) {
                clickTimer = setTimeout(function() {
                    clickCount = 0;
                    startHoldTimer(element, e);
                }, 300);
            } else if (clickCount === 2) {
                clearTimeout(clickTimer);
                clearTimeout(holdTimer);
                clickCount = 0;
                changeStress(e);
                return;
            }
            
            document.addEventListener('mousemove', checkMovement);
            document.addEventListener('mouseup', handleInteractionEnd);
        }

        function startHoldTimer(element, originalEvent) {
            holdTimer = setTimeout(function() {
                isHolding = true;
                startDrag(originalEvent);
            }, 600);
        }

        function checkMovement(e) {
            var clientX = e.clientX || (e.touches && e.touches[0].clientX);
            var clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            var distance = Math.sqrt(
                Math.pow(clientX - startPos.x, 2) + 
                Math.pow(clientY - startPos.y, 2)
            );
            
            if (distance > 15) {
                clearTimeout(holdTimer);
                clearTimeout(clickTimer);
                clickCount = 0;
            }
        }

        function handleInteractionEnd(e) {
            clearTimeout(holdTimer);
            
            document.removeEventListener('mousemove', checkMovement);
            document.removeEventListener('mouseup', handleInteractionEnd);
            
            if (isDragging) {
                stopDrag();
            }
        }

        function startDrag(e) {
            isDragging = true;
            dragElement = e.target.closest('.team-member');
            
            var rect = dragElement.getBoundingClientRect();
            var clientX = e.clientX || (e.touches && e.touches[0].clientX);
            var clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            dragOffset.x = clientX - rect.left;
            dragOffset.y = clientY - rect.top;
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function drag(e) {
            if (!isDragging || !dragElement) return;
            
            var workspace = document.getElementById('workspace');
            var workspaceRect = workspace.getBoundingClientRect();
            
            var clientX = e.clientX || (e.touches && e.touches[0].clientX);
            var clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            var newX = clientX - workspaceRect.left - dragOffset.x;
            var newY = clientY - workspaceRect.top - dragOffset.y;
            
            newX = Math.max(0, Math.min(newX, workspaceRect.width - 100));
            newY = Math.max(0, Math.min(newY, workspaceRect.height - 100));
            
            dragElement.style.left = newX + 'px';
            dragElement.style.top = newY + 'px';
            
            var memberId = parseInt(dragElement.dataset.id);
            var member = members.find(function(m) { return m.id === memberId; });
            if (member) {
                member.x = newX;
                member.y = newY;
            }
            
            updateConnections();
        }

        function stopDrag() {
            if (isDragging) {
                saveState();
            }
            
            isDragging = false;
            dragElement = null;
            
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }

        function changeStress(e) {
            if (isDragging || isHolding) return;
            
            e.stopPropagation();
            
            var memberId = parseInt(e.target.closest('.team-member').dataset.id);
            var member = members.find(function(m) { return m.id === memberId; });
            
            if (member) {
                member.stress = (member.stress % 5) + 1;
                e.target.closest('.team-member').className = 'team-member stress-' + member.stress;
                updateStats();
                saveState();
            }
        }

        function updateConnections() {
            var workspace = document.getElementById('workspace');
            var existingLines = workspace.querySelectorAll('.connection-line, .connection-emoji');
            for (var i = 0; i < existingLines.length; i++) {
                existingLines[i].remove();
            }
            
            for (var i = 0; i < connections.length; i++) {
                var connection = connections[i];
                var member1 = members.find(function(m) { return m.id === connection.member1; });
                var member2 = members.find(function(m) { return m.id === connection.member2; });
                
                if (!member1 || !member2) continue;
                
                var distance = Math.sqrt(
                    Math.pow(member1.x - member2.x, 2) + 
                    Math.pow(member1.y - member2.y, 2)
                );
                
                if (distance < 400) {
                    var line = document.createElement('div');
                    line.className = 'connection-line';
                    
                    var angle = Math.atan2(member2.y - member1.y, member2.x - member1.x);
                    var startX = member1.x + 50;
                    var startY = member1.y + 50;
                    
                    line.style.left = startX + 'px';
                    line.style.top = startY + 'px';
                    line.style.width = distance + 'px';
                    line.style.transform = 'rotate(' + angle + 'rad)';
                    
                    workspace.appendChild(line);
                    
                    var emojiDiv = document.createElement('div');
                    emojiDiv.className = 'connection-emoji';
                    emojiDiv.textContent = connection.emoji;
                    
                    var midX = startX + (distance / 2) * Math.cos(angle);
                    var midY = startY + (distance / 2) * Math.sin(angle);
                    
                    emojiDiv.style.left = midX + 'px';
                    emojiDiv.style.top = midY + 'px';
                    emojiDiv.style.transform = 'translate(-50%, -50%)';
                    
                    workspace.appendChild(emojiDiv);
                }
            }
        }

        function updateStats() {
            var avgStress = members.reduce(function(sum, m) { return sum + m.stress; }, 0) / members.length;
            var overloaded = members.filter(function(m) { return m.stress >= 4; }).length;
            
            document.getElementById('avgStress').textContent = 
                avgStress <= 2 ? 'Niedrig' : avgStress <= 3 ? 'Mittel' : 'Hoch';
            document.getElementById('overloaded').textContent = overloaded;
        }

        function showReflection() {
            var question = reflections[Math.floor(Math.random() * reflections.length)];
            showQuestionWithInput('Systemische Reflexion', question);
        }

        function showWonder() {
            var question = wonderQuestions[Math.floor(Math.random() * wonderQuestions.length)];
            showQuestionWithInput('L√∂sungsfokussierte Wunderfrage', question);
        }

        function showScaling() {
            var question = scalingQuestions[Math.floor(Math.random() * scalingQuestions.length)];
            showScalingPopup(question);
        }

        function showQuestionWithInput(title, question) {
            removeAllPopups();
            
            var questionId = 'q_' + Date.now();
            
            var popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = 
                '<button class="close-btn" onclick="removeAllPopups()">√ó</button>' +
                '<h3>' + title + '</h3>' +
                '<p>' + question + '</p>' +
                '<textarea class="text-response-area" id="response_' + questionId + '" ' +
                'placeholder="Deine Gedanken dazu... (max. 140 Zeichen)" maxlength="140"></textarea>' +
                '<div class="char-counter" id="counter_' + questionId + '">0/140</div>' +
                '<div style="text-align: center; margin-top: 15px;">' +
                '<button class="btn" onclick="submitResponse(\'' + questionId + '\', \'' + title + '\')">Gedanken festhalten</button>' +
                '<button class="btn" onclick="removeAllPopups()" style="margin-left: 10px;">√úberspringen</button>' +
                '</div>' +
                '<div id="aiResponse_' + questionId + '"></div>';
            
            document.body.appendChild(popup);
        }

        function submitResponse(questionId, questionType) {
            var textarea = document.getElementById('response_' + questionId);
            var response = textarea.value.trim();
            
            if (!response) {
                alert('Bitte teile deine Gedanken mit.');
                return;
            }
            
            userResponses.push({
                id: questionId,
                type: questionType,
                response: response,
                timestamp: new Date()
            });
            
            var aiContainer = document.getElementById('aiResponse_' + questionId);
            aiContainer.innerHTML = '<div class="ai-response">Danke f√ºr deine Reflexion! Diese flie√üt in dein Arbeitsblatt ein.</div>';
            
            textarea.disabled = true;
        }

        function showScalingPopup(question) {
            removeAllPopups();
            
            var popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = 
                '<button class="close-btn" onclick="removeAllPopups()">√ó</button>' +
                '<h3>üìä Systemische Skalierung</h3>' +
                '<p><strong>' + question.text + '</strong></p>' +
                '<p style="font-size: 14px; color: #ccc;">' + question.desc + '</p>' +
                '<div style="text-align: center; margin: 20px 0;">' +
                '<input type="range" min="1" max="10" value="5" id="scaleSlider" style="width: 100%; margin: 20px 0;">' +
                '<div style="font-size: 32px; font-weight: bold; color: #4CAF50; margin: 20px 0;" id="currentVal">5</div>' +
                '</div>' +
                '<div style="text-align: center; margin-top: 20px;">' +
                '<button class="btn" onclick="submitScaling()">Wert √ºbernehmen</button>' +
                '<button class="btn" onclick="removeAllPopups()" style="margin-left: 10px;">√úberspringen</button>' +
                '</div>';
            
            document.body.appendChild(popup);
        }

        function submitScaling() {
            var slider = document.getElementById('scaleSlider');
            var value = parseInt(slider.value);
            
            userResponses.push({
                id: 'scaling_' + Date.now(),
                type: 'Skalierung',
                response: 'Bewertung: ' + value + '/10',
                timestamp: new Date()
            });
            
            removeAllPopups();
            showPopup('Skalierung gespeichert', 'Deine Bewertung wurde erfasst und flie√üt in dein Arbeitsblatt ein.');
        }

        function addPerson() {
            var personName = prompt('Name der neuen Person:', 'Neue Person');
            if (!personName || personName.trim() === '') return;
            
            var newMember = {
                id: nextId++,
                name: personName.trim(),
                x: 100 + Math.random() * 400,
                y: 100 + Math.random() * 300,
                stress: 2
            };
            
            members.push(newMember);
            
            for (var i = 0; i < members.length; i++) {
                var existingMember = members[i];
                if (existingMember.id !== newMember.id) {
                    connections.push({
                        id: Math.min(newMember.id, existingMember.id) + '-' + Math.max(newMember.id, existingMember.id),
                        member1: newMember.id,
                        member2: existingMember.id,
                        emoji: 'ü§ù'
                    });
                }
            }
            
            createMembers();
            updateConnections();
            updateStats();
            saveState();
        }

        function showSessionSummary() {
            if (userResponses.length === 0) {
                showPopup('Session-√úbersicht', 'Du hast in dieser Session noch keine Reflexionsfragen beantwortet. Probiere die Reflexions-, Wunder- oder Skalierungsfragen aus!');
                return;
            }
            
            var reportHTML = '<h3>Deine Reflexionen</h3>';
            for (var i = 0; i < userResponses.length; i++) {
                var resp = userResponses[i];
                reportHTML += '<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">';
                reportHTML += '<strong>' + resp.type + ':</strong><br>';
                reportHTML += '<em>"' + resp.response + '"</em>';
                reportHTML += '</div>';
            }
            
            showPopup('Session-√úbersicht', reportHTML);
        }

        function exportSystemicWorksheet() {
            var pattern = analyzeUserPattern();
            var sessionDate = new Date().toLocaleDateString('de-DE');
            
            var userResponsesHTML = '';
            if (userResponses.length > 0) {
                userResponsesHTML = '<div class="section"><h2>üí¨ Deine Reflexionen</h2>';
                for (var i = 0; i < userResponses.length; i++) {
                    var resp = userResponses[i];
                    userResponsesHTML += '<p><strong>' + resp.type + ':</strong><br><em>"' + resp.response + '"</em></p>';
                }
                userResponsesHTML += '</div>';
            }
            
            var tasks = generatePersonalizedTasks(pattern);
            var questions = generateSystemicQuestions(pattern);
            
            var worksheetHTML = '<!DOCTYPE html>' +
'<html lang="de">' +
'<head>' +
    '<meta charset="UTF-8">' +
    '<title>Systemisches Arbeitsblatt - ' + sessionDate + '</title>' +
    '<style>' +
        'body { font-family: Arial, sans-serif; max-width: 21cm; margin: 0 auto; padding: 20px; line-height: 1.6; color: #333; }' +
        '.header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; border-radius: 15px; margin-bottom: 30px; }' +
        '.section { margin: 25px 0; padding: 20px; border-left: 4px solid #4CAF50; background: #f9f9f9; border-radius: 0 10px 10px 0; }' +
        '.note-field { margin-top: 15px; padding: 10px; background: #f8f9fa; border: 2px dashed #81C784; border-radius: 8px; }' +
        '.note-lines { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }' +
        '.note-line { height: 20px; border-bottom: 1px solid #81C784; }' +
        '@media print { body { margin: 0; padding: 15px; font-size: 12px; } }' +
    '</style>' +
'</head>' +
'<body>' +
    '<div class="header">' +
        '<h1>üéØ Systemisches Arbeitsblatt</h1>' +
        '<p>Reflexions-Radar Session vom ' + sessionDate + '</p>' +
    '</div>' +
    '<div class="section">' +
        '<h2>üé≠ Deine Selbstpositionierung</h2>' +
        '<p><strong>Erkannte Rolle:</strong> ' + pattern.role + '</p>' +
        '<p><strong>Dein Stress-Level:</strong> ' + pattern.userStress + '/5</p>' +
        '<p><strong>Position im Team:</strong> ' + pattern.position + '</p>' +
    '</div>' +
    userResponsesHTML +
    '<div class="section">' +
        '<h2>üîç Beobachtungsauftr√§ge</h2>';
        
        for (var i = 0; i < tasks.length; i++) {
            worksheetHTML += '<div style="margin: 20px 0;">' +
                '<p>' + tasks[i] + '</p>' +
                '<div class="note-field">' +
                    '<strong>üìù Deine Beobachtungen:</strong>' +
                    '<div class="note-lines">' +
                        '<div class="note-line"></div>' +
                        '<div class="note-line"></div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        worksheetHTML += '</div>' +
    '<div class="section">' +
        '<h2>üí≠ Reflexionsfragen</h2>';
        
        for (var i = 0; i < questions.length; i++) {
            worksheetHTML += '<div style="margin: 20px 0;">' +
                '<p><strong>' + questions[i] + '</strong></p>' +
                '<div class="note-field">' +
                    '<strong>üìù Deine Gedanken:</strong>' +
                    '<div class="note-lines">' +
                        '<div class="note-line"></div>' +
                        '<div class="note-line"></div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        worksheetHTML += '</div>' +
'</body>' +
'</html>';

            var blob = new Blob([worksheetHTML], { type: 'text/html;charset=utf-8' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'systemisches-arbeitsblatt-' + sessionDate.replace(/\./g, '-') + '.html';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showPopup('Arbeitsblatt erstellt!', 'Dein systemisches Arbeitsblatt wurde heruntergeladen. √ñffne es und drucke es aus f√ºr deine Beratung!');
        }

        function analyzeUserPattern() {
            var avgStress = members.reduce(function(sum, m) { return sum + m.stress; }, 0) / members.length;
            var userMember = members[0];
            var userStress = userMember.stress;
            
            var centerX = 400, centerY = 300;
            var userDistance = Math.sqrt(Math.pow(userMember.x - centerX, 2) + Math.pow(userMember.y - centerY, 2));
            var position = userDistance < 150 ? "zentral" : userDistance < 300 ? "aktiv" : "zur√ºckhaltend";
            
            var role = "Teammitglied";
            var focus = "Entwicklung";
            
            if (userStress >= 4 && position === "zentral") {
                role = "Harmonisiererin";
                focus = "Abgrenzung und Selbstf√ºrsorge";
            } else if (userStress >= 4 && position === "aktiv") {
                role = "Antreiberin";
                focus = "Vertrauen und Delegation";
            } else if (userStress <= 2 && position === "zur√ºckhaltend") {
                role = "Beobachterin";
                focus = "Sichtbarkeit und Initiative";
            } else if (userStress >= 3 && avgStress < userStress) {
                role = "Sorgentr√§gerin";
                focus = "Emotionale Entlastung";
            }
            
            return { role: role, position: position, userStress: userStress, focus: focus };
        }

        function generatePersonalizedTasks(pattern) {
            var allTasks = {
                "Harmonisiererin": [
                    "Beobachte eine Woche lang: Wann √ºbernimmst du automatisch eine vermittelnde Position?",
                    "Experimentiere: Sage 1x diese Woche 'Das besprechen Sie bitte direkt miteinander'",
                    "Frage dich: Was passiert, wenn du mal 5 Minuten wartest, bevor du eingreifst?"
                ],
                "Antreiberin": [
                    "Beobachte: In welchen Momenten √ºbergehst du andere mit deinem Tempo?",
                    "Experimentiere: Warte bei der n√§chsten Entscheidung bewusst auf andere Meinungen",
                    "Frage dich: Was passiert, wenn andere langsamer sind als du?"
                ],
                "Beobachterin": [
                    "Beobachte: Wann hast du Impulse, dich einzubringen, tust es aber nicht?",
                    "Experimentiere: √Ñu√üere 1x t√§glich eine Meinung, bevor andere sprechen",
                    "Frage dich: Was w√ºrde passieren, wenn du sichtbarer w√§rst?"
                ],
                "Sorgentr√§gerin": [
                    "Beobachte: Welche Sorgen von anderen tr√§gst du mit?",
                    "Experimentiere: Gib 1x eine Sorge an die Person zur√ºck, der sie geh√∂rt",
                    "Frage dich: Was m√ºsste passieren, damit andere ihre eigenen Sorgen tragen?"
                ]
            };
            
            return allTasks[pattern.role] || allTasks["Harmonisiererin"];
        }

        function generateSystemicQuestions(pattern) {
            var allQuestions = {
                "Harmonisiererin": [
                    "Wer hat dir diese Vermittlerrolle urspr√ºnglich √ºbertragen?",
                    "Was bef√ºrchtest du, w√ºrde passieren, wenn du nicht mehr vermittelst?",
                    "Wenn du f√ºr eine Woche 'Urlaub' von dieser Rolle h√§ttest - wer w√ºrde es merken?"
                ],
                "Antreiberin": [
                    "Woher kommt dein innerer Antrieb? Wessen Stimme h√∂rst du da?",
                    "Wann kannst du dein Tempo drosseln, ohne Angst zu haben?",
                    "Wie w√ºrde das Team deine 'langsamere Version' erleben?"
                ],
                "Beobachterin": [
                    "Was ist der Wert deiner beobachtenden Position f√ºr das Team?",
                    "Was m√ºsste im Team anders sein, damit du dich sicherer zeigen k√∂nntest?",
                    "Welche wichtigen Dinge siehst du, die andere √ºbersehen?"
                ],
                "Sorgentr√§gerin": [
                    "Von wem hast du gelernt, dass du f√ºr andere mitverantwortlich bist?",
                    "Wem w√ºrdest du zutrauen, seine eigenen Sorgen zu tragen?",
                    "Wie w√ºrde sich Erleichterung f√ºr dich im Team anf√ºhlen?"
                ]
            };
            
            return allQuestions[pattern.role] || allQuestions["Harmonisiererin"];
        }

        function showPopup(title, message) {
            removeAllPopups();
            
            var popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = 
                '<button class="close-btn" onclick="removeAllPopups()">√ó</button>' +
                '<h3>' + title + '</h3>' +
                '<div>' + message + '</div>' +
                '<div style="text-align: center; margin-top: 15px;">' +
                '<button class="btn" onclick="removeAllPopups()">Verstanden</button>' +
                '</div>';
            
            document.body.appendChild(popup);
            
            setTimeout(function() {
                removeAllPopups();
            }, 8000);
        }

        function removeAllPopups() {
            var popups = document.querySelectorAll('.popup');
            for (var i = 0; i < popups.length; i++) {
                popups[i].remove();
            }
        }

        function resetAll() {
            if (confirm('M√∂chtest du wirklich eine neue Session beginnen? Alle aktuellen Daten gehen verloren.')) {
                members = [
                    { id: 1, name: 'Anna\n(Projektleitung)', x: 200, y: 150, stress: 4 },
                    { id: 2, name: 'Marcus\n(Entwicklung)', x: 400, y: 250, stress: 3 },
                    { id: 3, name: 'Sarah\n(Design)', x: 300, y: 400, stress: 1 },
                    { id: 4, name: 'Tom\n(QA)', x: 600, y: 200, stress: 2 }
                ];
                nextId = 5;
                userResponses = [];
                stateHistory = [];
                currentStateIndex = -1;
                
                initConnections();
                createMembers();
                updateConnections();
                updateStats();
                saveState();
                
                showPopup('Neue Session gestartet!', 'Du kannst jetzt eine frische Reflexion beginnen.');
            }
        }

        // Start the app
        window.addEventListener('load', init);
        
        // Prevent context menu on team members
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.team-member')) {
                e.preventDefault();
            }
        });
        
    </script>
</body>
</html>
