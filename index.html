<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflexions-Radar v2.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; }
        .header { background: rgba(255,255,255,0.1); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); border-radius: 0 0 20px 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); flex-wrap: wrap; gap: 10px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { font-size: 24px; font-weight: bold; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .settings-icon { font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; user-select: none; }
        .settings-icon:hover { background: rgba(255,255,255,0.2); transform: rotate(45deg); }
        .controls { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { padding: 8px 16px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; color: white; cursor: pointer; transition: all 0.3s ease; font-size: 13px; white-space: nowrap; backdrop-filter: blur(10px); }
        .btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn.export-btn { background: linear-gradient(135deg, rgba(76,175,80,0.3), rgba(69,160,73,0.3)); border: 1px solid rgba(76,175,80,0.4); font-weight: bold; }
        
        .menu-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .menu-overlay.open { opacity: 1; visibility: visible; }
        .backup-menu { position: fixed; top: 0; right: 0; width: 350px; height: 100vh; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.2); z-index: 1000; padding: 30px; overflow-y: auto; transform: translateX(100%); transition: transform 0.3s ease; }
        .backup-menu.open { transform: translateX(0); }
        .save-new-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .backup-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white; font-size: 14px; margin-bottom: 10px; }
        .backup-input::placeholder { color: rgba(255,255,255,0.6); }
        .backup-item { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .backup-item-title { font-weight: bold; color: #81C784; margin-bottom: 8px; font-size: 14px; }
        .backup-item-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .backup-actions { display: flex; gap: 8px; }
        .backup-btn { padding: 4px 12px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 15px; color: white; font-size: 11px; cursor: pointer; transition: all 0.2s ease; }
        .backup-btn:hover { background: rgba(255,255,255,0.25); }
        .backup-btn.delete { background: rgba(244,67,54,0.3); border-color: rgba(244,67,54,0.5); }
        .backup-btn.delete:hover { background: rgba(244,67,54,0.5); }
        
        .workspace { position: relative; height: calc(100vh - 100px); overflow: hidden; }
        .team-member { position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(15px); border: 2px solid rgba(255,255,255,0.3); font-weight: bold; text-align: center; font-size: 12px; user-select: none; width: 100px; height: 100px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
        .team-member:hover { transform: scale(1.05); }
        .stress-1 { background: linear-gradient(135deg, rgba(46,125,50,0.8), rgba(76,175,80,0.8)); }
        .stress-2 { background: linear-gradient(135deg, rgba(104,159,56,0.8), rgba(139,195,74,0.8)); }
        .stress-3 { background: linear-gradient(135deg, rgba(255,152,0,0.8), rgba(255,183,77,0.8)); }
        .stress-4 { background: linear-gradient(135deg, rgba(245,124,0,0.8), rgba(255,143,0,0.8)); }
        .stress-5 { background: linear-gradient(135deg, rgba(244,67,54,0.8), rgba(239,83,80,0.8)); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .connection-line { position: absolute; height: 3px; background: rgba(255,255,255,0.4); transform-origin: left center; cursor: pointer; border-radius: 2px; }
        .connection-emoji { position: absolute; background: rgba(0,0,0,0.6); color: white; padding: 6px 10px; border-radius: 15px; font-size: 16px; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); z-index: 100; }
        .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 30px; border-radius: 20px; max-width: 500px; z-index: 1000; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); }
        .popup h3 { color: #81C784; margin-bottom: 15px; font-size: 18px; }
        .close-btn { position: absolute; top: 15px; right: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 18px; cursor: pointer; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        
        .legend { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); min-width: 200px; }
        .legend h4 { margin-bottom: 15px; color: #81C784; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; }
        .legend-circle { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; }
        .stats { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); }
        .text-response-area { width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px; border-radius: 10px; margin: 15px 0; font-size: 14px; min-height: 80px; font-family: inherit; }
        .ai-response { background: rgba(129,199,132,0.2); border-left: 4px solid #81C784; padding: 15px; margin: 15px 0; border-radius: 10px; font-style: italic; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">üéØ Reflexions-Radar</div>
            <div class="settings-icon" onclick="toggleBackupMenu()">‚öôÔ∏è</div>
        </div>
        <div class="controls">
            <button class="btn" id="reflectionBtn">üí≠ Reflexion</button>
            <button class="btn" id="scalingBtn">üìä Skalierung</button>
            <button class="btn" id="wonderBtn">‚ú® Wunderfrage</button>
            <button class="btn" id="addPersonBtn">+ Person</button>
            <button class="btn" id="backBtn">‚Ü©Ô∏è Zur√ºck</button>
            <button class="btn" id="forwardBtn">‚Ü™Ô∏è Vorw√§rts</button>
            <button class="btn" id="sessionBtn">üìÑ Session</button>
            <button class="btn export-btn" id="worksheetBtn">üìã Arbeitsblatt</button>
            <button class="btn" id="resetBtn">üîÑ Reset</button>
        </div>
    </div>

    <div class="menu-overlay" id="menuOverlay" onclick="closeBackupMenu()"></div>
    <div class="backup-menu" id="backupMenu">
        <h3>‚öôÔ∏è Session-Verwaltung <button class="close-btn" onclick="closeBackupMenu()">√ó</button></h3>
        <div class="save-new-section">
            <h4 style="color: white; margin-bottom: 10px;">üíæ Aktuelle Session speichern</h4>
            <input type="text" class="backup-input" id="backupNameInput" placeholder="Session-Name eingeben..." maxlength="30">
            <button class="btn" onclick="saveCurrentState()" style="width: 100%; margin-top: 5px;">Speichern</button>
        </div>
        <div>
            <h4 style="color: white; margin-bottom: 15px;">üìÅ Gespeicherte Sessions</h4>
            <div id="backupList">
                <p style="color: #ccc; font-style: italic; text-align: center; padding: 20px;">Noch keine Sessions gespeichert</p>
            </div>
        </div>
    </div>

    <div class="workspace" id="workspace">
        <div class="legend">
            <h4>Stress-Level</h4>
            <div class="legend-item"><div class="legend-circle stress-1"></div><span>1 - Sehr entspannt</span></div>
            <div class="legend-item"><div class="legend-circle stress-2"></div><span>2 - Entspannt</span></div>
            <div class="legend-item"><div class="legend-circle stress-3"></div><span>3 - Angespannt</span></div>
            <div class="legend-item"><div class="legend-circle stress-4"></div><span>4 - Sehr angespannt</span></div>
            <div class="legend-item"><div class="legend-circle stress-5"></div><span>5 - √úberlastet</span></div>
            <div style="margin-top: 15px; font-size: 11px; color: #ccc;">üí° Doppelklick = Stress √§ndern<br>üñ±Ô∏è Halten & Ziehen = Position √§ndern<br>üîó Linie klicken = Beziehung bearbeiten</div>
        </div>
        <div class="stats">
            <h4 style="color: #81C784; margin-bottom: 10px;">Reflexions-Impulse</h4>
            <div style="font-size: 12px; line-height: 1.4;">
                <div>Durchschnittlicher Stress: <span id="avgStress">Mittel</span></div>
                <div>Belastete Bereiche: <span id="overloaded">1</span></div>
                <div style="margin-top: 10px; color: #ccc;">üí≠ Betrachte deine Position<br>üéØ Erkenne Muster<br>üå± Reflektiere deinen Beitrag</div>
            </div>
        </div>
    </div>

    <script>
        var members = [
            { id: 1, name: 'Anna\n(Projektleitung)', x: 200, y: 150, stress: 4 },
            { id: 2, name: 'Marcus\n(Entwicklung)', x: 400, y: 250, stress: 3 },
            { id: 3, name: 'Sarah\n(Design)', x: 300, y: 400, stress: 1 },
            { id: 4, name: 'Tom\n(QA)', x: 600, y: 200, stress: 2 }
        ];
        var connections = [], nextId = 5, isDragging = false, dragElement = null, dragOffset = { x: 0, y: 0 };
        var userResponses = [], stateHistory = [], currentStateIndex = -1, savedStates = [], backupMenuOpen = false;
        var clickCount = 0, clickTimer = null, holdTimer = null, isHolding = false, startPos = { x: 0, y: 0 };

        var reflections = [
            "ü™û Welche Rolle √ºbernimmst du normalerweise in stressigen Teamsituationen?",
            "üí≠ Was ist dein automatisches Verhalten, wenn im Team Spannungen entstehen?",
            "üå± Wof√ºr ist deine Position im Team n√ºtzlich - auch wenn sie manchmal anstrengend ist?"
        ];

        function init() {
            initConnections(); createMembers(); updateConnections(); updateStats(); saveState();
            document.getElementById('reflectionBtn').addEventListener('click', showReflection);
            document.getElementById('sessionBtn').addEventListener('click', showSessionSummary);
            document.getElementById('worksheetBtn').addEventListener('click', exportSystemicWorksheet);
            document.getElementById('resetBtn').addEventListener('click', resetAll);
            document.getElementById('backBtn').addEventListener('click', goBack);
            document.getElementById('forwardBtn').addEventListener('click', goForward);
            setTimeout(() => showPopup('Reflexions-Radar v2.0! üéØ', '‚öôÔ∏è Backup-System verf√ºgbar<br>Phase 1 & 2 abgeschlossen!'), 1000);
        }

        function initConnections() {
            connections = [];
            for (var i = 0; i < members.length; i++) {
                for (var j = i + 1; j < members.length; j++) {
                    connections.push({ id: members[i].id + '-' + members[j].id, member1: members[i].id, member2: members[j].id, emoji: 'ü§ù' });
                }
            }
        }

        function createMembers() {
            var workspace = document.getElementById('workspace');
            var existingMembers = workspace.querySelectorAll('.team-member');
            for (var i = 0; i < existingMembers.length; i++) existingMembers[i].remove();
            
            for (var i = 0; i < members.length; i++) {
                var member = members[i], div = document.createElement('div');
                div.className = 'team-member stress-' + member.stress;
                div.style.left = member.x + 'px'; div.style.top = member.y + 'px';
                div.textContent = member.name; div.dataset.id = member.id;
                div.addEventListener('mousedown', handleInteractionStart);
                workspace.appendChild(div);
            }
        }

        function handleInteractionStart(e) {
            e.preventDefault();
            var clientX = e.clientX || (e.touches && e.touches[0].clientX);
            var clientY = e.clientY || (e.touches && e.touches[0].clientY);
            startPos = { x: clientX, y: clientY }; isHolding = false;
            
            clickCount++;
            if (clickCount === 1) {
                clickTimer = setTimeout(() => { clickCount = 0; startHoldTimer(e.target, e); }, 300);
            } else if (clickCount === 2) {
                clearTimeout(clickTimer); clearTimeout(holdTimer); clickCount = 0; changeStress(e);
            }
        }

        function startHoldTimer(element, originalEvent) {
            holdTimer = setTimeout(() => { isHolding = true; startDrag(originalEvent); }, 600);
        }

        function startDrag(e) {
            isDragging = true; dragElement = e.target.closest('.team-member');
            var rect = dragElement.getBoundingClientRect();
            var clientX = e.clientX || (e.touches && e.touches[0].clientX);
            var clientY = e.clientY || (e.touches && e.touches[0].clientY);
            dragOffset.x = clientX - rect.left; dragOffset.y = clientY - rect.top;
            document.addEventListener('mousemove', drag); document.addEventListener('mouseup', stopDrag);
        }

        function drag(e) {
            if (!isDragging || !dragElement) return;
            var workspace = document.getElementById('workspace'), workspaceRect = workspace.getBoundingClientRect();
            var clientX = e.clientX || (e.touches && e.touches[0].clientX);
            var clientY = e.clientY || (e.touches && e.touches[0].clientY);
            var newX = Math.max(0, Math.min(clientX - workspaceRect.left - dragOffset.x, workspaceRect.width - 100));
            var newY = Math.max(0, Math.min(clientY - workspaceRect.top - dragOffset.y, workspaceRect.height - 100));
            dragElement.style.left = newX + 'px'; dragElement.style.top = newY + 'px';
            var member = members.find(m => m.id === parseInt(dragElement.dataset.id));
            if (member) { member.x = newX; member.y = newY; } updateConnections();
        }

        function stopDrag() {
            if (isDragging) saveState();
            isDragging = false; dragElement = null;
            document.removeEventListener('mousemove', drag); document.removeEventListener('mouseup', stopDrag);
        }

        function changeStress(e) {
            if (isDragging || isHolding) return;
            e.stopPropagation();
            var memberId = parseInt(e.target.closest('.team-member').dataset.id);
            var member = members.find(m => m.id === memberId);
            if (member) {
                member.stress = (member.stress % 5) + 1;
                e.target.closest('.team-member').className = 'team-member stress-' + member.stress;
                updateStats(); saveState();
            }
        }

        function updateConnections() {
            var workspace = document.getElementById('workspace');
            var existingLines = workspace.querySelectorAll('.connection-line, .connection-emoji');
            for (var i = 0; i < existingLines.length; i++) existingLines[i].remove();
            
            for (var i = 0; i < connections.length; i++) {
                var connection = connections[i];
                var member1 = members.find(m => m.id === connection.member1);
                var member2 = members.find(m => m.id === connection.member2);
                if (!member1 || !member2) continue;
                
                var distance = Math.sqrt(Math.pow(member1.x - member2.x, 2) + Math.pow(member1.y - member2.y, 2));
                if (distance < 400) {
                    var line = document.createElement('div');
                    line.className = 'connection-line';
                    var angle = Math.atan2(member2.y - member1.y, member2.x - member1.x);
                    var startX = member1.x + 50, startY = member1.y + 50;
                    line.style.left = startX + 'px'; line.style.top = startY + 'px';
                    line.style.width = distance + 'px'; line.style.transform = 'rotate(' + angle + 'rad)';
                    workspace.appendChild(line);
                    
                    var emojiDiv = document.createElement('div');
                    emojiDiv.className = 'connection-emoji'; emojiDiv.textContent = connection.emoji;
                    var midX = startX + (distance / 2) * Math.cos(angle);
                    var midY = startY + (distance / 2) * Math.sin(angle);
                    emojiDiv.style.left = midX + 'px'; emojiDiv.style.top = midY + 'px';
                    emojiDiv.style.transform = 'translate(-50%, -50%)';
                    workspace.appendChild(emojiDiv);
                }
            }
        }

        function updateStats() {
            var avgStress = members.reduce((sum, m) => sum + m.stress, 0) / members.length;
            var overloaded = members.filter(m => m.stress >= 4).length;
            document.getElementById('avgStress').textContent = avgStress <= 2 ? 'Niedrig' : avgStress <= 3 ? 'Mittel' : 'Hoch';
            document.getElementById('overloaded').textContent = overloaded;
        }

        function showReflection() {
            var question = reflections[Math.floor(Math.random() * reflections.length)];
            showQuestionWithInput('Systemische Reflexion', question);
        }

        function showQuestionWithInput(title, question) {
            removeAllPopups();
            var questionId = 'q_' + Date.now();
            var popup = document.createElement('div'); popup.className = 'popup';
            popup.innerHTML = '<button class="close-btn" onclick="removeAllPopups()">√ó</button><h3>' + title + '</h3><p>' + question + '</p>' +
                '<textarea class="text-response-area" id="response_' + questionId + '" placeholder="Deine Gedanken..." maxlength="140"></textarea>' +
                '<div style="text-align: center; margin-top: 15px;"><button class="btn" onclick="submitResponse(\'' + questionId + '\', \'' + title + '\')">Festhalten</button></div>';
            document.body.appendChild(popup);
        }

        function submitResponse(questionId, questionType) {
            var textarea = document.getElementById('response_' + questionId), response = textarea.value.trim();
            if (!response) { alert('Bitte teile deine Gedanken mit.'); return; }
            userResponses.push({ id: questionId, type: questionType, input: response, userInput: response, timestamp: new Date() });
            textarea.parentElement.innerHTML += '<div class="ai-response">Danke! Flie√üt ins Arbeitsblatt ein.</div>';
            textarea.disabled = true;
        }

        function showSessionSummary() {
            var content = '<h3>üéØ Session-Zusammenfassung</h3>';
            if (userResponses.length === 0) {
                content += '<p>Noch keine Reflexionen in dieser Session.</p>';
            } else {
                content += '<p><strong>Reflexionen:</strong> ' + userResponses.length + '</p>';
                for (var i = 0; i < userResponses.length; i++) {
                    var resp = userResponses[i];
                    content += '<div style="margin: 10px 0; padding: 10px; border-left: 3px solid #4CAF50; background: rgba(76,175,80,0.1);">';
                    content += '<strong>' + resp.type + ':</strong> ' + resp.input + '</div>';
                }
            }
            showInfoMessage(content);
        }

        function showInfoMessage(content) {
            removeAllPopups();
            var popup = document.createElement('div'); popup.className = 'popup';
            popup.innerHTML = '<button class="close-btn" onclick="removeAllPopups()">√ó</button>' + content +
                '<div style="text-align: center; margin-top: 20px;"><button class="btn" onclick="removeAllPopups()">Schlie√üen</button></div>';
            document.body.appendChild(popup);
        }

        function exportSystemicWorksheet() {
            var html = '<!DOCTYPE html><html><head><title>Arbeitsblatt</title><style>body{font-family:Arial;padding:20px;}</style></head><body>' +
                '<h1>üéØ Reflexions-Radar Arbeitsblatt</h1><h2>Team:</h2>';
            for (var i = 0; i < members.length; i++) {
                html += '<p><strong>' + members[i].name + '</strong> - Stress: ' + members[i].stress + '/5</p>';
            }
            if (userResponses.length > 0) {
                html += '<h2>Reflexionen:</h2>';
                for (var j = 0; j < userResponses.length; j++) {
                    html += '<p><strong>' + userResponses[j].type + ':</strong> ' + userResponses[j].input + '</p>';
                }
            }
            html += '</body></html>';
            
            var blob = new Blob([html], { type: 'text/html' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url; link.download = 'reflexions-arbeitsblatt.html';
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showPopup('Export fertig!', 'Arbeitsblatt wurde heruntergeladen.');
        }

        function saveState() {
            var state = { members: JSON.parse(JSON.stringify(members)), connections: JSON.parse(JSON.stringify(connections)), timestamp: Date.now() };
            stateHistory = stateHistory.slice(0, currentStateIndex + 1); stateHistory.push(state);
            currentStateIndex = stateHistory.length - 1;
            if (stateHistory.length > 20) { stateHistory.shift(); currentStateIndex--; }
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            document.getElementById('backBtn').disabled = currentStateIndex <= 0;
            document.getElementById('forwardBtn').disabled = currentStateIndex >= stateHistory.length - 1;
        }

        function goBack() {
            if (currentStateIndex > 0) {
                currentStateIndex--; var state = stateHistory[currentStateIndex];
                members = JSON.parse(JSON.stringify(state.members)); connections = JSON.parse(JSON.stringify(state.connections));
                createMembers(); updateConnections(); updateStats(); updateNavigationButtons();
            }
        }

        function goForward() {
            if (currentStateIndex < stateHistory.length - 1) {
                currentStateIndex++; var state = stateHistory[currentStateIndex];
                members = JSON.parse(JSON.stringify(state.members)); connections = JSON.parse(JSON.stringify(state.connections));
                createMembers(); updateConnections(); updateStats(); updateNavigationButtons();
            }
        }

        function resetAll() {
            if (confirm('Neue Session beginnen?')) {
                members = [
                    { id: 1, name: 'Anna\n(Projektleitung)', x: 200, y: 150, stress: 4 },
                    { id: 2, name: 'Marcus\n(Entwicklung)', x: 400, y: 250, stress: 3 },
                    { id: 3, name: 'Sarah\n(Design)', x: 300, y: 400, stress: 1 },
                    { id: 4, name: 'Tom\n(QA)', x: 600, y: 200, stress: 2 }
                ];
                nextId = 5; userResponses = []; stateHistory = []; currentStateIndex = -1;
                initConnections(); createMembers(); updateConnections(); updateStats(); saveState();
                showPopup('Reset!', 'Neue Session gestartet.');
            }
        }

        // BACKUP SYSTEM
        function toggleBackupMenu() {
            var menu = document.getElementById('backupMenu'), overlay = document.getElementById('menuOverlay');
            if (backupMenuOpen) { closeBackupMenu(); } 
            else { menu.classList.add('open'); overlay.classList.add('open'); backupMenuOpen = true; updateBackupList(); }
        }

        function closeBackupMenu() {
            var menu = document.getElementById('backupMenu'), overlay = document.getElementById('menuOverlay');
            menu.classList.remove('open'); overlay.classList.remove('open'); backupMenuOpen = false;
        }

        function saveCurrentState() {
            var nameInput = document.getElementById('backupNameInput'), sessionName = nameInput.value.trim();
            if (!sessionName) { alert('Bitte Session-Namen eingeben.'); return; }
            
            var currentState = {
                id: 'backup_' + Date.now(), name: sessionName, timestamp: new Date(),
                members: JSON.parse(JSON.stringify(members)), connections: JSON.parse(JSON.stringify(connections)),
                userResponses: JSON.parse(JSON.stringify(userResponses)),
                stressStats: { avgStress: members.reduce((sum, m) => sum + m.stress, 0) / members.length, overloaded: members.filter(m => m.stress >= 4).length }
            };
            
            savedStates.push(currentState); nameInput.value = ''; updateBackupList();
            showPopup('Session gespeichert! üíæ', 'Session "' + sessionName + '" wurde gespeichert.');
        }

        function loadState(stateId) {
            var state = savedStates.find(s => s.id === stateId);
            if (!state) return;
            if (confirm('Session "' + state.name + '" laden? Aktuelle √Ñnderungen gehen verloren.')) {
                members = JSON.parse(JSON.stringify(state.members)); connections = JSON.parse(JSON.stringify(state.connections));
                userResponses = JSON.parse(JSON.stringify(state.userResponses));
                createMembers(); updateConnections(); updateStats(); saveState(); closeBackupMenu();
                showPopup('Session geladen! üìÅ', 'Session "' + state.name + '" wurde geladen.');
            }
        }

        function deleteState(stateId) {
            var state = savedStates.find(s => s.id === stateId);
            if (!state) return;
            if (confirm('Session "' + state.name + '" wirklich l√∂schen?')) {
                savedStates = savedStates.filter(s => s.id !== stateId); updateBackupList();
                showPopup('Session gel√∂scht', 'Session wurde entfernt.');
            }
        }

        function updateBackupList() {
            var listContainer = document.getElementById('backupList');
            if (savedStates.length === 0) {
                listContainer.innerHTML = '<p style="color: #ccc; font-style: italic; text-align: center; padding: 20px;">Noch keine Sessions gespeichert</p>';
                return;
            }
            
            var listHTML = '';
            for (var i = savedStates.length - 1; i >= 0; i--) {
                var state = savedStates[i];
                var timeString = state.timestamp.toLocaleDateString('de-DE') + ' ' + state.timestamp.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                listHTML += '<div class="backup-item"><div class="backup-item-title">' + state.name + '</div>' +
                    '<div class="backup-item-info"><span>' + timeString + '</span>' +
                    '<div class="backup-actions"><button class="backup-btn" onclick="loadState(\'' + state.id + '\')">Laden</button>' +
                    '<button class="backup-btn delete" onclick="deleteState(\'' + state.id + '\')">L√∂schen</button></div></div>' +
                    '<div style="font-size: 11px; color: #aaa; margin-top: 5px;">' +
                    state.members.length + ' Personen, √ò Stress: ' + state.stressStats.avgStress.toFixed(1) + '/5, ' +
                    state.userResponses.length + ' Reflexionen</div></div>';
            }
            listContainer.innerHTML = listHTML;
        }

        function showPopup(title, message) {
            removeAllPopups();
            var popup = document.createElement('div'); popup.className = 'popup';
            popup.innerHTML = '<button class="close-btn" onclick="removeAllPopups()">√ó</button><h3>' + title + '</h3><div>' + message + '</div>' +
                '<div style="text-align: center; margin-top: 15px;"><button class="btn" onclick="removeAllPopups()">Verstanden</button></div>';
            document.body.appendChild(popup);
            setTimeout(() => removeAllPopups(), 8000);
        }

        function removeAllPopups() {
            var popups = document.querySelectorAll('.popup');
            for (var i = 0; i < popups.length; i++) popups[i].remove();
        }

        window.addEventListener('load', init);
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.team-member')) e.preventDefault();
        });
    </script>
</body>
</html>
